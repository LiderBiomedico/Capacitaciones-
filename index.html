<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Capacitaciones - Hospital Susana L√≥pez de Valencia</title>
    
    <meta name="description" content="Sistema integral de gesti√≥n de capacitaciones hospitalarias">
    <meta name="theme-color" content="#667eea">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè•</text></svg>">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Axios para peticiones HTTP -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Pantalla de Carga -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loader">
            <i class="fas fa-hospital fa-beat"></i>
            <p>Cargando Sistema...</p>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div>
                        <h1>üè• Sistema de Capacitaciones</h1>
                        <p>Hospital Susana L√≥pez de Valencia</p>
                        <p style="font-size: 0.8rem; color: #888;">Desarrollado por Ing. Paul Eduardo Mu√±oz Rodr√≠guez</p>
                    </div>
                </div>
                <div class="header-actions">
                    <div id="connectionIndicator" class="connection-indicator disconnected" onclick="testAirtableConnection(true)">
                        <span class="connection-dot"></span>
                        <span id="connectionText">‚úó Airtable Desconectado</span>
                    </div>
                    <div class="date-time">
                        <i class="far fa-calendar-alt"></i>
                        <span id="currentDateTime"></span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="navigation">
            <button class="nav-tab active" data-tab="dashboard" onclick="switchTab('dashboard')">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
            </button>
            <button class="nav-tab" data-tab="create" onclick="switchTab('create')">
                <i class="fas fa-plus-circle"></i>
                <span>Crear</span>
            </button>
            <button class="nav-tab" data-tab="manage" onclick="switchTab('manage')">
                <i class="fas fa-tasks"></i>
                <span>Gestionar</span>
            </button>
            <button class="nav-tab" data-tab="exam" onclick="switchTab('exam')">
                <i class="fas fa-clipboard-check"></i>
                <span>Examen</span>
            </button>
            <button class="nav-tab" data-tab="reports" onclick="switchTab('reports')">
                <i class="fas fa-file-alt"></i>
                <span>Reportes</span>
            </button>
            <button class="nav-tab" data-tab="settings" onclick="switchTab('settings')">
                <i class="fas fa-cog"></i>
                <span>Ajustes</span>
            </button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h2 class="section-title">
                    <i class="fas fa-chart-line"></i>
                    Panel de Control
                </h2>
                
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-icon"><i class="fas fa-graduation-cap"></i></div>
                        <div class="stat-info">
                            <h3 id="totalTrainings">0</h3>
                            <p>Capacitaciones Activas</p>
                        </div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-info">
                            <h3 id="totalParticipants">0</h3>
                            <p>Participantes Totales</p>
                        </div>
                    </div>
                    <div class="stat-card purple">
                        <div class="stat-icon"><i class="fas fa-chart-bar"></i></div>
                        <div class="stat-info">
                            <h3 id="averageScore">0%</h3>
                            <p>Promedio de Mejora</p>
                        </div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-icon"><i class="fas fa-percentage"></i></div>
                        <div class="stat-info">
                            <h3 id="adherenceRate">0%</h3>
                            <p>Tasa de Adherencia</p>
                        </div>
                    </div>
                </div>

                <div class="charts-container">
                    <div class="card">
                        <h3><i class="fas fa-chart-line"></i> Participaciones por D√≠a</h3>
                        <canvas id="participationsChart" height="300"></canvas>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-chart-bar"></i> Rendimiento por Departamento</h3>
                        <canvas id="departmentChart" height="300"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-history"></i> Actividad Reciente</h3>
                    <div id="recentActivity" class="activity-list">
                        <p class="no-data">No hay actividad reciente</p>
                    </div>
                </div>
            </div>

            <!-- Create Tab -->
            <div id="create" class="tab-content">
                <h2 class="section-title">
                    <i class="fas fa-plus-circle"></i>
                    Crear Nueva Capacitaci√≥n
                </h2>
                
                <form id="trainingForm" onsubmit="saveTraining(event)">
                    <div class="card">
                        <h3><i class="fas fa-info-circle"></i> Informaci√≥n B√°sica</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="trainingTitle">
                                    <i class="fas fa-heading"></i> T√≠tulo de la Capacitaci√≥n
                                </label>
                                <input type="text" id="trainingTitle" required 
                                       placeholder="Ej: Bioseguridad Hospitalaria 2025">
                                <small>T√≠tulo descriptivo que ver√°n los participantes</small>
                            </div>
                            <div class="form-group">
                                <label for="trainingDepartment">
                                    <i class="fas fa-building"></i> Departamento
                                </label>
                                <select id="trainingDepartment" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="General">General</option>
                                    <option value="Enfermer√≠a">Enfermer√≠a</option>
                                    <option value="Medicina">Medicina</option>
                                    <option value="Administraci√≥n">Administraci√≥n</option>
                                    <option value="Laboratorio">Laboratorio</option>
                                    <option value="Radiolog√≠a">Radiolog√≠a</option>
                                    <option value="Urgencias">Urgencias</option>
                                    <option value="UCI">UCI</option>
                                    <option value="Quir√≥fano">Quir√≥fano</option>
                                    <option value="Pediatr√≠a">Pediatr√≠a</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="trainingDescription">
                                <i class="fas fa-align-left"></i> Descripci√≥n
                            </label>
                            <textarea id="trainingDescription" rows="4" required
                                      placeholder="Describe el objetivo y contenido de la capacitaci√≥n..."></textarea>
                            <small>Informaci√≥n detallada sobre la capacitaci√≥n</small>
                        </div>
                    </div>

                    <!-- Preguntas Pretest -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-question-circle"></i> Preguntas Pre-test</h3>
                            <button type="button" class="btn btn-primary" onclick="addQuestion('pretest')">
                                <i class="fas fa-plus"></i> Agregar Pregunta
                            </button>
                        </div>
                        <div id="pretestQuestions"></div>
                    </div>

                    <!-- Preguntas Post-test -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-question-circle"></i> Preguntas Post-test</h3>
                            <button type="button" class="btn btn-primary" onclick="addQuestion('posttest')">
                                <i class="fas fa-plus"></i> Agregar Pregunta
                            </button>
                        </div>
                        <div id="posttestQuestions"></div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Guardar Capacitaci√≥n
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            <i class="fas fa-redo"></i> Limpiar Formulario
                        </button>
                    </div>
                </form>
            </div>

            <!-- Manage Tab -->
            <div id="manage" class="tab-content">
                <h2 class="section-title">
                    <i class="fas fa-tasks"></i>
                    Gestionar Capacitaciones
                </h2>
                
                <div class="card">
                    <div class="card-header">
                        <h3>Capacitaciones Registradas</h3>
                        <button class="btn btn-primary" onclick="loadTrainings()">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>
                    <div id="trainingsList">
                        <p class="no-data">Cargando capacitaciones...</p>
                    </div>
                </div>
            </div>

            <!-- Exam Tab -->
            <div id="exam" class="tab-content">
                <h2 class="section-title">
                    <i class="fas fa-clipboard-check"></i>
                    Acceso a Examen
                </h2>
                
                <div class="card">
                    <h3><i class="fas fa-key"></i> Ingresar C√≥digo de Acceso</h3>
                    <div class="form-group">
                        <input type="text" id="accessCode" placeholder="Ingrese el c√≥digo de 6 d√≠gitos">
                    </div>
                    <button class="btn btn-primary" onclick="accessTraining()">
                        <i class="fas fa-sign-in-alt"></i> Acceder
                    </button>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <h2 class="section-title">
                    <i class="fas fa-file-alt"></i>
                    Reportes y Estad√≠sticas
                </h2>
                
                <div class="card">
                    <h3>Generar Reportes</h3>
                    <div class="form-group">
                        <label>Tipo de Reporte</label>
                        <select id="reportType">
                            <option value="general">Reporte General</option>
                            <option value="department">Por Departamento</option>
                            <option value="training">Por Capacitaci√≥n</option>
                            <option value="participant">Por Participante</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-success" onclick="generateReport('csv')">
                            <i class="fas fa-file-csv"></i> Exportar CSV
                        </button>
                        <button class="btn btn-danger" onclick="generateReport('pdf')">
                            <i class="fas fa-file-pdf"></i> Exportar PDF
                        </button>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <h2 class="section-title">
                    <i class="fas fa-cog"></i>
                    Configuraci√≥n
                </h2>
                
                <div class="card">
                    <h3><i class="fas fa-database"></i> Credenciales de Airtable</h3>
                    <p style="color: #666; margin-bottom: 20px;">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Modo Seguro:</strong> Las credenciales se configuran en el servidor (Netlify) 
                        y NO se guardan en el navegador.
                    </p>
                    
                    <div class="form-group">
                        <label>Estado de Conexi√≥n</label>
                        <div id="connectionStatus" class="badge danger">Desconectado</div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="testAirtableConnection(true)">
                        <i class="fas fa-plug"></i> Probar Conexi√≥n
                    </button>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="margin-bottom: 15px;">üìã Instrucciones de Configuraci√≥n</h4>
                        <ol style="padding-left: 20px;">
                            <li style="margin-bottom: 10px;">
                                Configura las variables de entorno en Netlify:
                                <ul style="padding-left: 20px; margin-top: 5px;">
                                    <li><code>AIRTABLE_API_KEY</code> = tu Personal Access Token</li>
                                    <li><code>AIRTABLE_BASE_ID</code> = tu Base ID</li>
                                </ul>
                            </li>
                            <li style="margin-bottom: 10px;">
                                Para desarrollo local, copia las credenciales en el archivo <code>.env</code>
                            </li>
                            <li style="margin-bottom: 10px;">
                                Haz clic en "Probar Conexi√≥n" para verificar
                            </li>
                        </ol>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-info-circle"></i> Informaci√≥n del Sistema</h3>
                    <p><strong>Versi√≥n:</strong> 1.0.0</p>
                    <p><strong>√öltima Actualizaci√≥n:</strong> Noviembre 2025</p>
                    <p><strong>Desarrollado por:</strong> Ing. Paul Eduardo Mu√±oz Rodr√≠guez</p>
                </div>
            </div>

        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2025 Hospital Susana L√≥pez de Valencia</p>
            <p>Sistema de Capacitaciones - Versi√≥n 1.0.0</p>
        </footer>
    </div>

    <!-- Modal para C√≥digo QR -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 style="text-align: center;">‚úÖ Capacitaci√≥n Creada</h2>
            
            <div class="access-info">
                <p><strong>C√≥digo de Acceso:</strong> <span id="modalAccessCode"></span></p>
                <p><strong>Link Directo:</strong> <span id="modalAccessLink"></span></p>
            </div>
            
            <div class="qr-container">
                <div id="qrcode"></div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="copyToClipboard()">
                    <i class="fas fa-copy"></i> Copiar
                </button>
                <button class="btn btn-success" onclick="shareWhatsApp()">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </button>
                <button class="btn btn-info" onclick="downloadQR()">
                    <i class="fas fa-download"></i> Descargar QR
                </button>
                <button class="btn btn-secondary" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let pretestQuestionCount = 0;
        let posttestQuestionCount = 0;
        let airtableConnected = false;
        let connectionCheckInterval = null;

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Sistema de Capacitaciones Iniciado');
            
            // Ocultar pantalla de carga
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
            }, 1500);
            
            // Actualizar fecha y hora
            updateDateTime();
            setInterval(updateDateTime, 60000);
            
            // Verificar conexi√≥n con Airtable
            testAirtableConnection(false);
            
            // Verificar cada 30 segundos
            connectionCheckInterval = setInterval(() => {
                testAirtableConnection(false);
            }, 30000);
            
            // Inicializar gr√°ficos
            initializeCharts();
            
            // Verificar par√°metros de URL
            checkUrlParams();
        });

        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            const dateTimeString = now.toLocaleDateString('es-CO', options);
            document.getElementById('currentDateTime').textContent = dateTimeString;
        }

        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                document.getElementById('accessCode').value = code;
                switchTab('exam');
            }
        }

        function switchTab(tabName) {
            // Actualizar tabs activos
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                }
            });
            
            // Actualizar contenido visible
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            // Ejecutar acciones espec√≠ficas
            if (tabName === 'manage' && airtableConnected) {
                loadTrainings();
            }
        }

        // ==========================================
        // CONEXI√ìN AIRTABLE
        // ==========================================
        
        function updateConnectionIndicator(status) {
            const indicator = document.getElementById('connectionIndicator');
            const text = document.getElementById('connectionText');
            const statusBadge = document.getElementById('connectionStatus');
            
            indicator.classList.remove('connected', 'disconnected', 'checking');
            
            switch(status) {
                case 'connected':
                    indicator.classList.add('connected');
                    text.textContent = '‚úì Airtable Conectado';
                    if (statusBadge) {
                        statusBadge.textContent = 'Conectado';
                        statusBadge.className = 'badge success';
                    }
                    airtableConnected = true;
                    break;
                case 'disconnected':
                    indicator.classList.add('disconnected');
                    text.textContent = '‚úó Airtable Desconectado';
                    if (statusBadge) {
                        statusBadge.textContent = 'Desconectado';
                        statusBadge.className = 'badge danger';
                    }
                    airtableConnected = false;
                    break;
                case 'checking':
                    indicator.classList.add('checking');
                    text.textContent = '‚ü≥ Verificando...';
                    break;
            }
        }

        async function testAirtableConnection(showMessage = false) {
            try {
                updateConnectionIndicator('checking');
                
                if (showMessage) {
                    Swal.fire({
                        title: 'Probando Conexi√≥n',
                        text: 'Verificando credenciales de Airtable...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                }
                
                const response = await airtableRequest('GET', '/Capacitaciones?maxRecords=1');
                
                if (response) {
                    updateConnectionIndicator('connected');
                    console.log('‚úÖ Conexi√≥n exitosa con Airtable');
                    
                    if (showMessage) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Conexi√≥n Exitosa',
                            text: 'Conectado correctamente a Airtable',
                            timer: 2000
                        });
                    }
                    
                    return true;
                }
            } catch (error) {
                updateConnectionIndicator('disconnected');
                console.error('‚ùå Error de conexi√≥n:', error.message);
                
                if (showMessage) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de Conexi√≥n',
                        html: `
                            <p>${error.message}</p>
                            <hr>
                            <p><strong>Verifica que:</strong></p>
                            <ul style="text-align: left;">
                                <li>Las funciones de Netlify est√©n configuradas</li>
                                <li>Las variables de entorno est√©n correctas</li>
                                <li>La base de Airtable est√© accesible</li>
                            </ul>
                        `
                    });
                }
                
                return false;
            }
        }

        // ==========================================
        // GESTI√ìN DE PREGUNTAS
        // ==========================================
        
        function addQuestion(type) {
            const container = type === 'pretest' 
                ? document.getElementById('pretestQuestions')
                : document.getElementById('posttestQuestions');
            
            const count = type === 'pretest' ? ++pretestQuestionCount : ++posttestQuestionCount;
            
            const questionDiv = document.createElement('div');
            questionDiv.className = 'exam-question';
            questionDiv.id = `${type}-q${count}`;
            questionDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4>Pregunta ${count}</h4>
                    <button type="button" class="btn btn-danger" onclick="removeQuestion('${type}', ${count})" 
                            style="padding: 5px 10px; font-size: 0.9rem;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="form-group">
                    <textarea id="${type}-question-${count}" rows="3" required
                              placeholder="Escriba la pregunta aqu√≠..."></textarea>
                </div>
            `;
            
            container.appendChild(questionDiv);
            
            Swal.fire({
                icon: 'success',
                title: 'Pregunta Agregada',
                text: `Pregunta ${count} del ${type === 'pretest' ? 'Pre-test' : 'Post-test'}`,
                timer: 1500,
                showConfirmButton: false
            });
        }

        function removeQuestion(type, number) {
            const questionDiv = document.getElementById(`${type}-q${number}`);
            if (questionDiv) {
                Swal.fire({
                    title: '¬øEliminar Pregunta?',
                    text: `Se eliminar√° la pregunta ${number}`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'S√≠, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        questionDiv.remove();
                        if (type === 'pretest') pretestQuestionCount--;
                        else posttestQuestionCount--;
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Pregunta Eliminada',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                });
            }
        }

        // ==========================================
        // GUARDAR CAPACITACI√ìN
        // ==========================================
        
        async function saveTraining(event) {
            event.preventDefault();
            
            if (!airtableConnected) {
                Swal.fire({
                    icon: 'error',
                    title: 'No Conectado',
                    text: 'Primero debes conectarte a Airtable'
                });
                return;
            }
            
            // Validar que haya al menos una pregunta
            if (pretestQuestionCount === 0 || posttestQuestionCount === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Preguntas Requeridas',
                    text: 'Debes agregar al menos una pregunta de pre-test y una de post-test'
                });
                return;
            }
            
            // Mostrar loading
            Swal.fire({
                title: 'Guardando Capacitaci√≥n',
                text: 'Por favor espera...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            try {
                // Obtener datos del formulario
                const title = document.getElementById('trainingTitle').value;
                const department = document.getElementById('trainingDepartment').value;
                const description = document.getElementById('trainingDescription').value;
                
                // Recopilar preguntas pretest
                const pretestQuestions = [];
                for (let i = 1; i <= pretestQuestionCount; i++) {
                    const questionElement = document.getElementById(`pretest-question-${i}`);
                    if (questionElement) {
                        pretestQuestions.push({
                            numero: i,
                            pregunta: questionElement.value
                        });
                    }
                }
                
                // Recopilar preguntas posttest
                const posttestQuestions = [];
                for (let i = 1; i <= posttestQuestionCount; i++) {
                    const questionElement = document.getElementById(`posttest-question-${i}`);
                    if (questionElement) {
                        posttestQuestions.push({
                            numero: i,
                            pregunta: questionElement.value
                        });
                    }
                }
                
                // 1. Crear la capacitaci√≥n
                const trainingData = {
                    fields: {
                        "T√≠tulo": title,
                        "Descripci√≥n": description,
                        "Departamento": department,
                        "Activa": true,
                        "Fecha Creaci√≥n": new Date().toISOString()
                    }
                };
                
                const trainingResponse = await airtableRequest('POST', '/Capacitaciones', trainingData);
                const trainingId = trainingResponse.id;
                
                console.log('‚úÖ Capacitaci√≥n creada:', trainingId);
                
                // 2. Crear preguntas pretest
                for (const q of pretestQuestions) {
                    const questionData = {
                        fields: {
                            "Capacitaci√≥n": [trainingId],
                            "Tipo": "Pretest",
                            "N√∫mero": q.numero,
                            "Pregunta": q.pregunta
                        }
                    };
                    await airtableRequest('POST', '/Preguntas', questionData);
                }
                
                console.log(`‚úÖ ${pretestQuestions.length} preguntas pretest creadas`);
                
                // 3. Crear preguntas posttest
                for (const q of posttestQuestions) {
                    const questionData = {
                        fields: {
                            "Capacitaci√≥n": [trainingId],
                            "Tipo": "Post-test",
                            "N√∫mero": q.numero,
                            "Pregunta": q.pregunta
                        }
                    };
                    await airtableRequest('POST', '/Preguntas', questionData);
                }
                
                console.log(`‚úÖ ${posttestQuestions.length} preguntas posttest creadas`);
                
                // 4. Crear sesi√≥n con c√≥digo de acceso
                const accessCode = generateAccessCode();
                const accessLink = `${window.location.origin}${window.location.pathname}?code=${accessCode}`;
                
                const sessionData = {
                    fields: {
                        "Capacitaci√≥n": [trainingId],
                        "C√≥digo Acceso": accessCode,
                        "Link Acceso": accessLink,
                        "Fecha Inicio": new Date().toISOString(),
                        "Activa": true
                    }
                };
                
                await airtableRequest('POST', '/Sesiones', sessionData);
                
                console.log('‚úÖ Sesi√≥n creada con c√≥digo:', accessCode);
                
                // Cerrar loading
                Swal.close();
                
                // Mostrar modal con c√≥digo QR
                showQRModal(accessCode, accessLink);
                
                // Limpiar formulario
                performReset();
                
            } catch (error) {
                console.error('‚ùå Error guardando capacitaci√≥n:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error al Guardar',
                    text: error.message
                });
            }
        }

        function generateAccessCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function showQRModal(code, link) {
            const modal = document.getElementById('qrModal');
            document.getElementById('modalAccessCode').textContent = code;
            document.getElementById('modalAccessLink').textContent = link;
            
            // Limpiar QR anterior
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            
            // Generar nuevo QR
            new QRCode(qrContainer, {
                text: link,
                width: 256,
                height: 256,
                colorDark: '#000000',
                colorLight: '#ffffff'
            });
            
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        // ==========================================
        // FUNCIONES DE MODAL
        // ==========================================
        
        function copyToClipboard() {
            const code = document.getElementById('modalAccessCode').textContent;
            const link = document.getElementById('modalAccessLink').textContent;
            const text = `üè• Acceso a Capacitaci√≥n\n\nC√≥digo: ${code}\nLink: ${link}\n\nHospital Susana L√≥pez de Valencia`;
            
            navigator.clipboard.writeText(text).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'Copiado',
                    text: 'Informaci√≥n copiada al portapapeles',
                    timer: 2000,
                    showConfirmButton: false
                });
            });
        }

        function shareWhatsApp() {
            const code = document.getElementById('modalAccessCode').textContent;
            const link = document.getElementById('modalAccessLink').textContent;
            const message = `üè• *Acceso a Capacitaci√≥n*\nHospital Susana L√≥pez de Valencia\n\n*C√≥digo:* ${code}\n*Link:* ${link}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        }

        function downloadQR() {
            const canvas = document.querySelector('#qrcode canvas');
            if (canvas) {
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const code = document.getElementById('modalAccessCode').textContent;
                    link.download = `QR-${code}.png`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                });
            }
        }

        function resetForm() {
            if (pretestQuestionCount > 0 || posttestQuestionCount > 0) {
                Swal.fire({
                    title: '¬øLimpiar Formulario?',
                    text: 'Se perder√°n todas las preguntas',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'S√≠, limpiar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        performReset();
                    }
                });
            } else {
                performReset();
            }
        }

        function performReset() {
            document.getElementById('trainingForm').reset();
            document.getElementById('pretestQuestions').innerHTML = '';
            document.getElementById('posttestQuestions').innerHTML = '';
            pretestQuestionCount = 0;
            posttestQuestionCount = 0;
        }

        // ==========================================
        // CARGAR CAPACITACIONES
        // ==========================================
        
        async function loadTrainings() {
            if (!airtableConnected) {
                document.getElementById('trainingsList').innerHTML = 
                    '<p class="no-data">Primero debes conectarte a Airtable</p>';
                return;
            }
            
            document.getElementById('trainingsList').innerHTML = 
                '<p class="loading-message"><i class="fas fa-spinner fa-spin"></i> Cargando...</p>';
            
            try {
                const response = await airtableRequest('GET', '/Capacitaciones');
                
                if (!response || !response.records || response.records.length === 0) {
                    document.getElementById('trainingsList').innerHTML = 
                        '<p class="no-data">No hay capacitaciones registradas</p>';
                    return;
                }
                
                let html = '<div class="table-responsive"><table class="data-table"><thead><tr>' +
                    '<th>T√≠tulo</th>' +
                    '<th>Departamento</th>' +
                    '<th>Estado</th>' +
                    '<th>Fecha</th>' +
                    '</tr></thead><tbody>';
                
                response.records.forEach(record => {
                    const fields = record.fields;
                    html += `<tr>
                        <td>${fields.T√≠tulo || 'Sin t√≠tulo'}</td>
                        <td>${fields.Departamento || 'N/A'}</td>
                        <td><span class="badge ${fields.Activa ? 'success' : 'danger'}">
                            ${fields.Activa ? 'Activa' : 'Inactiva'}</span></td>
                        <td>${fields['Fecha Creaci√≥n'] ? new Date(fields['Fecha Creaci√≥n']).toLocaleDateString('es-CO') : 'N/A'}</td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                document.getElementById('trainingsList').innerHTML = html;
                
            } catch (error) {
                console.error('Error cargando capacitaciones:', error);
                document.getElementById('trainingsList').innerHTML = 
                    `<p class="no-data">Error: ${error.message}</p>`;
            }
        }

        // ==========================================
        // GR√ÅFICOS
        // ==========================================
        
        let participationsChart = null;
        let departmentChart = null;

        function initializeCharts() {
            const ctx1 = document.getElementById('participationsChart');
            if (ctx1 && !participationsChart) {
                participationsChart = new Chart(ctx1.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
                        datasets: [{
                            label: 'Participaciones',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            const ctx2 = document.getElementById('departmentChart');
            if (ctx2 && !departmentChart) {
                departmentChart = new Chart(ctx2.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['Enfermer√≠a', 'Medicina', 'Admin', 'Lab', 'Radiolog√≠a'],
                        datasets: [{
                            label: 'Rendimiento',
                            data: [0, 0, 0, 0, 0],
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.8)',
                                'rgba(100, 210, 80, 0.8)',
                                'rgba(217, 65, 244, 0.8)',
                                'rgba(248, 150, 30, 0.8)',
                                'rgba(52, 172, 224, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }
        }

        // ==========================================
        // FUNCIONES STUB
        // ==========================================
        
        function accessTraining() {
            Swal.fire('En desarrollo', 'Funci√≥n en construcci√≥n', 'info');
        }

        function generateReport(type) {
            Swal.fire('En desarrollo', `Exportar ${type.toUpperCase()} en construcci√≥n`, 'info');
        }

        // Limpiar intervalo al cerrar
        window.addEventListener('beforeunload', () => {
            if (connectionCheckInterval) clearInterval(connectionCheckInterval);
        });
    </script>
</body>
</html>
