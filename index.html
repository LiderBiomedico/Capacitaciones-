<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Capacitaciones - Hospital Susana L√≥pez de Valencia</title>
    
    <meta name="description" content="Sistema integral de gesti√≥n de capacitaciones hospitalarias">
    <meta name="theme-color" content="#667eea">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè•</text></svg>">
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè•</text></svg>">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 30px rgba(0,0,0,0.08);
        }

        /* Header */
        .header {
            background: white;
            padding: 1.5rem 2rem;
            border-bottom: 2px solid #f0f0f0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-section h1 {
            color: var(--primary);
            font-size: 1.5rem;
            margin: 0;
        }

        .logo-section p {
            color: #666;
            font-size: 0.9rem;
            margin: 0.25rem 0;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .connection-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border: 1px solid #81c784;
            border-radius: 20px;
            font-size: 0.85em;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            user-select: none;
        }

        .connection-indicator:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .connection-indicator.connected {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border-color: #4caf50;
            color: #2e7d32;
        }

        .connection-indicator.disconnected {
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
            border-color: #ef5350;
            color: #c62828;
        }

        .connection-indicator.checking {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-color: #ffa726;
            color: #e65100;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
            display: inline-block;
        }

        .connection-indicator.disconnected .connection-dot {
            background: #ef5350;
            animation: none;
            box-shadow: none;
        }

        .connection-indicator.checking .connection-dot {
            background: #ffa726;
            animation: pulse-fast 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            50% { opacity: 0.7; box-shadow: 0 0 0 4px rgba(76, 175, 80, 0); }
        }

        @keyframes pulse-fast {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(255, 167, 38, 0.7); }
            50% { opacity: 0.7; box-shadow: 0 0 0 4px rgba(255, 167, 38, 0); }
        }

        /* Navigation */
        .navigation {
            display: flex;
            background: white;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
            position: sticky;
            top: 100px;
            z-index: 999;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 1rem;
            background: white;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            color: #666;
        }

        .nav-tab i {
            font-size: 1.3rem;
        }

        .nav-tab:hover {
            background: #f8f9fa;
            color: var(--primary);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: #f8f9ff;
        }

        /* Main Content */
        .main-content {
            padding: 2rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .section-title {
            color: var(--primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.8rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: var(--primary);
            margin-bottom: 1rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-icon {
            font-size: 3rem;
            opacity: 0.8;
        }

        .stat-info h3 {
            font-size: 2rem;
            margin: 0;
            color: white;
        }

        .stat-info p {
            margin: 0;
            opacity: 0.9;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        /* Questions Container */
        .questions-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .question-counter {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .question-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s;
        }

        .question-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(102,126,234,0.15);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .question-header h4 {
            color: var(--primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-remove {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-remove:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .question-text {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            transition: all 0.3s;
        }

        .question-text:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: white;
            padding: 0.75rem;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .option-item:hover {
            border-color: var(--primary);
            background: #f8f9ff;
        }

        .option-item input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .radio-label {
            font-size: 0.85rem;
            color: #666;
            min-width: 70px;
            font-weight: 500;
        }

        .option-text {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .option-text:focus {
            outline: none;
            border-color: var(--primary);
        }

        .help-text {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-content h2 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .close {
            position: absolute;
            right: 1rem;
            top: 1rem;
            font-size: 2rem;
            cursor: pointer;
            color: #666;
        }

        .close:hover {
            color: var(--danger);
        }

        .qr-container {
            display: flex;
            justify-content: center;
            margin: 1.5rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .access-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .access-info p {
            margin: 0.5rem 0;
        }

        .access-info strong {
            color: var(--primary);
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .modal-actions button {
            flex: 1;
        }

        /* Charts */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .charts-container canvas {
            max-height: 300px;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }

        .loader {
            text-align: center;
            color: white;
        }

        .loader i {
            font-size: 4rem;
            animation: pulse 1.5s infinite;
        }

        /* Footer */
        .footer {
            background: #f8f9fa;
            padding: 2rem;
            text-align: center;
            border-top: 2px solid #e0e0e0;
        }

        .footer p {
            margin: 0.5rem 0;
            color: #666;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }

            .form-actions {
                flex-direction: column;
            }

            .form-actions .btn {
                width: 100%;
            }
        }

        /* ==================== GESTIONAR CAPACITACIONES ==================== */
        
        .trainings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .training-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .training-card:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.2);
            transform: translateY(-5px);
        }

        .training-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .training-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .training-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .training-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .training-status.active {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .training-status.inactive {
            background: #ffebee;
            color: #c62828;
        }

        .training-info {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .training-info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #555;
        }

        .training-info-item i {
            width: 20px;
            color: var(--primary);
        }

        .training-code {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            margin: 1rem 0;
        }

        .training-code-label {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-bottom: 0.25rem;
        }

        .training-code-value {
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: 3px;
        }

        .training-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-action {
            flex: 1;
            padding: 0.6rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-view {
            background: #e3f2fd;
            color: #1976d2;
        }

        .btn-view:hover {
            background: #1976d2;
            color: white;
        }

        .btn-qr {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .btn-qr:hover {
            background: #7b1fa2;
            color: white;
        }

        .btn-delete {
            background: #ffebee;
            color: #c62828;
        }

        .btn-delete:hover {
            background: #c62828;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #999;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: #666;
        }

        .empty-state p {
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }

        /* Modal de detalles */
        .details-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .details-modal.active {
            display: flex;
        }

        .details-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .details-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 2rem;
            border-radius: 12px 12px 0 0;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .details-body {
            padding: 2rem;
        }

        .details-section {
            margin-bottom: 2rem;
        }

        .details-section h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .questions-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .question-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .question-number {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .question-text {
            font-weight: 500;
            margin-bottom: 0.75rem;
            color: #333;
        }

        .question-options {
            display: grid;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        .question-option {
            padding: 0.5rem;
            background: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .question-option.correct {
            background: #e8f5e9;
            border-left: 3px solid #4caf50;
            font-weight: 500;
        }

        .loading-spinner {
            text-align: center;
            padding: 3rem;
            color: var(--primary);
        }

        .loading-spinner i {
            font-size: 3rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loader">
            <i class="fas fa-heartbeat"></i>
            <p>Cargando Sistema de Capacitaciones...</p>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div>
                        <h1>üè• Sistema de Capacitaciones</h1>
                        <p>Hospital Susana L√≥pez de Valencia</p>
                        <p style="font-size: 0.8em; font-style: italic;">Desarrollado por Ing. Paul Eduardo Mu√±oz Rodriguez</p>
                    </div>
                </div>
                <div class="header-actions">
                    <div id="connectionIndicator" class="connection-indicator connected" onclick="testAirtableConnection()" title="Click para reconectar">
                        <div class="connection-dot"></div>
                        <span id="connectionText">Airtable Conectado</span>
                    </div>
                    <span id="currentDateTime"></span>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="navigation">
            <button class="nav-tab active" onclick="switchTab('dashboard')">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
            </button>
            <button class="nav-tab" onclick="switchTab('create')">
                <i class="fas fa-plus-circle"></i>
                <span>Crear</span>
            </button>
            <button class="nav-tab" onclick="switchTab('manage')">
                <i class="fas fa-tasks"></i>
                <span>Gestionar</span>
            </button>
            <button class="nav-tab" onclick="switchTab('exam')">
                <i class="fas fa-clipboard-check"></i>
                <span>Examen</span>
            </button>
            <button class="nav-tab" onclick="switchTab('reports')">
                <i class="fas fa-chart-bar"></i>
                <span>Reportes</span>
            </button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            
            <!-- Dashboard Tab -->
            <section id="dashboard" class="tab-content active">
                <h2 class="section-title">
                    <i class="fas fa-chart-line"></i> Panel de Control
                </h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-graduation-cap"></i></div>
                        <div class="stat-info">
                            <h3 id="totalTrainings">0</h3>
                            <p>Capacitaciones Activas</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-info">
                            <h3 id="totalParticipants">0</h3>
                            <p>Participantes Totales</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-percentage"></i></div>
                        <div class="stat-info">
                            <h3 id="adherenceRate">0%</h3>
                            <p>Tasa de Adherencia</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="stat-info">
                            <h3 id="avgImprovement">0%</h3>
                            <p>Mejora Promedio</p>
                        </div>
                    </div>
                </div>

                <div class="charts-container">
                    <div class="card">
                        <h3>Participaciones por D√≠a</h3>
                        <canvas id="participationsChart"></canvas>
                    </div>
                    
                    <div class="card">
                        <h3>Rendimiento por Departamento</h3>
                        <canvas id="departmentChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Create Tab -->
            <section id="create" class="tab-content">
                <h2 class="section-title">
                    <i class="fas fa-plus-circle"></i> Crear Nueva Capacitaci√≥n
                </h2>
                
                <div class="card">
                    <h3>üìã Informaci√≥n General</h3>
                    <form id="trainingForm">
                        <div class="form-group">
                            <label><i class="fas fa-graduation-cap"></i> Capacitaci√≥n *</label>
                            <input type="text" id="trainingTitle" required placeholder="Ej: Protocolo de Higiene de Manos">
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-align-left"></i> Descripci√≥n</label>
                            <textarea id="trainingDescription" rows="3" placeholder="Describe los objetivos..."></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label><i class="fas fa-calendar"></i> Fecha de Creaci√≥n *</label>
                                <input type="date" id="trainingDate" required>
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-building"></i> Departamento *</label>
                                <select id="trainingDepartment" required>
                                    <option value="">Seleccione...</option>
                                    <option value="General">General</option>
                                    <option value="Enfermer√≠a">Enfermer√≠a</option>
                                    <option value="Medicina">Medicina</option>
                                    <option value="Administraci√≥n">Administraci√≥n</option>
                                    <option value="Laboratorio">Laboratorio</option>
                                    <option value="Radiolog√≠a">Radiolog√≠a</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-clock"></i> Duraci√≥n</label>
                                <input type="text" id="trainingDuration" placeholder="Ej: 30 minutos">
                            </div>
                        </div>

                        <div class="form-group">
                            <label><i class="fas fa-users-cog"></i> Personal Capacitado *</label>
                            <div id="trainingStaffContainer" style="background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 8px; padding: 1rem; max-height: 300px; overflow-y: auto;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.3s;" onmouseover="this.style.background='#e8f0ff'" onmouseout="this.style.background='transparent'">
                                        <input type="checkbox" value="Jefe de Enfermer√≠a" class="trainingStaff" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                        <span>Jefe de Enfermer√≠a</span>
                                    </label>
                                    
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.3s;" onmouseover="this.style.background='#e8f0ff'" onmouseout="this.style.background='transparent'">
                                        <input type="checkbox" value="M√©dico General" class="trainingStaff" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                        <span>M√©dico General</span>
                                    </label>
                                    
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.3s;" onmouseover="this.style.background='#e8f0ff'" onmouseout="this.style.background='transparent'">
                                        <input type="checkbox" value="M√©dico Especialista" class="trainingStaff" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                        <span>M√©dico Especialista</span>
                                    </label>
                                    
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.3s;" onmouseover="this.style.background='#e8f0ff'" onmouseout="this.style.background='transparent'">
                                        <input type="checkbox" value="Ingeniero Biom√©dico" class="trainingStaff" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                        <span>Ingeniero Biom√©dico</span>
                                    </label>
                                    
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.3s;" onmouseover="this.style.background='#e8f0ff'" onmouseout="this.style.background='transparent'">
                                        <input type="checkbox" value="Estudiante" class="trainingStaff" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                        <span>Estudiante</span>
                                    </label>
                                    
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.3s;" onmouseover="this.style.background='#e8f0ff'" onmouseout="this.style.background='transparent'">
                                        <input type="checkbox" value="Auxiliar de Enfermer√≠a" class="trainingStaff" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                        <span>Auxiliar de Enfermer√≠a</span>
                                    </label>
                                    
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.3s;" onmouseover="this.style.background='#e8f0ff'" onmouseout="this.style.background='transparent'">
                                        <input type="checkbox" value="Terapeuta Respiratorio" class="trainingStaff" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                        <span>Terapeuta Respiratorio</span>
                                    </label>
                                    
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.3s;" onmouseover="this.style.background='#e8f0ff'" onmouseout="this.style.background='transparent'">
                                        <input type="checkbox" value="Fisioterapeuta" class="trainingStaff" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                        <span>Fisioterapeuta</span>
                                    </label>
                                    
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.3s;" onmouseover="this.style.background='#e8f0ff'" onmouseout="this.style.background='transparent'">
                                        <input type="checkbox" value="Conductor" class="trainingStaff" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                        <span>Conductor</span>
                                    </label>
                                    
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.3s;" onmouseover="this.style.background='#e8f0ff'" onmouseout="this.style.background='transparent'">
                                        <input type="checkbox" value="T√©cnico de Rayos X" class="trainingStaff" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                        <span>T√©cnico de Rayos X</span>
                                    </label>
                                    
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.3s;" onmouseover="this.style.background='#e8f0ff'" onmouseout="this.style.background='transparent'">
                                        <input type="checkbox" value="Fonoaudi√≥logo" class="trainingStaff" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                        <span>Fonoaudi√≥logo</span>
                                    </label>
                                    
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.3s;" onmouseover="this.style.background='#e8f0ff'" onmouseout="this.style.background='transparent'">
                                        <input type="checkbox" value="Instrumentador Quir√∫rgico" class="trainingStaff" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                        <span>Instrumentador Quir√∫rgico</span>
                                    </label>
                                    
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.3s;" onmouseover="this.style.background='#e8f0ff'" onmouseout="this.style.background='transparent'">
                                        <input type="checkbox" value="Administrativo" class="trainingStaff" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                        <span>Administrativo</span>
                                    </label>
                                </div>
                            </div>
                            <small class="help-text">Selecciona el personal que recibir√° esta capacitaci√≥n</small>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <h3>‚ùì Pretest (Evaluaci√≥n Inicial)</h3>
                    <div id="pretestQuestions" class="questions-container"></div>
                    <button class="btn btn-secondary" onclick="addQuestion('pretest')">
                        <i class="fas fa-plus"></i> Agregar Pregunta
                    </button>
                </div>

                <div class="card">
                    <h3>‚úÖ Post-test (Evaluaci√≥n Final)</h3>
                    <div id="posttestQuestions" class="questions-container"></div>
                    <button class="btn btn-secondary" onclick="addQuestion('posttest')">
                        <i class="fas fa-plus"></i> Agregar Pregunta
                    </button>
                </div>

                <div class="form-actions">
                    <button class="btn btn-primary" onclick="saveTraining()">
                        <i class="fas fa-save"></i> Guardar Capacitaci√≥n
                    </button>
                    <button class="btn btn-secondary" onclick="resetForm()">
                        <i class="fas fa-undo"></i> Limpiar Formulario
                    </button>
                </div>
            </section>

            <!-- Other tabs... -->
            <section id="manage" class="tab-content">
                <h2 class="section-title"><i class="fas fa-tasks"></i> Gestionar Capacitaciones</h2>
                
                <!-- Loading State -->
                <div id="trainingsLoading" class="loading-spinner" style="display: none;">
                    <i class="fas fa-spinner"></i>
                    <p>Cargando capacitaciones...</p>
                </div>

                <!-- Empty State -->
                <div id="trainingsEmpty" class="empty-state" style="display: none;">
                    <i class="fas fa-inbox"></i>
                    <h3>No hay capacitaciones creadas</h3>
                    <p>Las capacitaciones que crees aparecer√°n aqu√≠</p>
                    <button class="btn btn-primary" onclick="switchTab('create')">
                        <i class="fas fa-plus"></i> Crear Primera Capacitaci√≥n
                    </button>
                </div>

                <!-- Trainings Grid -->
                <div id="trainingsGrid" class="trainings-grid"></div>
            </section>

            <!-- Modal para mostrar QR generado -->
            <div id="qrModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 500px; padding: 2rem; text-align: center;">
                    <button class="modal-close" onclick="closeQRModal()">&times;</button>
                    
                    <h3 style="margin-bottom: 1.5rem;">
                        <i class="fas fa-qrcode"></i> C√≥digo QR Generado
                    </h3>
                    
                    <p style="color: #666; margin-bottom: 1.5rem;">
                        Captura este c√≥digo QR o comparte el enlace con tu personal
                    </p>
                    
                    <!-- Contenedor para el QR -->
                    <div id="qrCodeContainer" style="background: white; padding: 1.5rem; border-radius: 8px; border: 2px solid #e0e0e0; margin-bottom: 1.5rem; display: flex; justify-content: center;">
                        <div id="qrCode"></div>
                    </div>
                    
                    <!-- URL para compartir -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="font-weight: bold; color: #333; display: block; margin-bottom: 0.5rem;">
                            <i class="fas fa-link"></i> Enlace de Acceso
                        </label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="qrUrl" readonly style="flex: 1; padding: 0.75rem; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 0.85rem; background: #f8f9fa;">
                            <button class="btn btn-secondary" onclick="copyQRUrl()" style="padding: 0.75rem 1rem; white-space: nowrap;">
                                <i class="fas fa-copy"></i> Copiar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Instrucciones -->
                    <div style="background: #f0f8ff; padding: 1rem; border-radius: 6px; text-align: left; margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #2196F3;">
                            <i class="fas fa-info-circle"></i> Instrucciones
                        </h4>
                        <ol style="margin: 0; padding-left: 1.25rem; color: #555; font-size: 0.9rem;">
                            <li>Imprime este c√≥digo QR</li>
                            <li>Col√≥calo en el hospital (carteles, pasillos)</li>
                            <li>O comparte el enlace por WhatsApp/Email</li>
                            <li>Cuando alguien lo escanee, se abrir√° autom√°ticamente</li>
                            <li>‚úÖ La sesi√≥n se crear√° autom√°ticamente en Airtable</li>
                        </ol>
                    </div>
                    
                    <!-- Botones de acci√≥n -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <button class="btn btn-primary" onclick="downloadQRCode()" style="margin: 0;">
                            <i class="fas fa-download"></i> Descargar
                        </button>
                        <button class="btn btn-secondary" onclick="closeQRModal()" style="margin: 0;">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                </div>
            </div>

            <section id="exam" class="tab-content">
                <h2 class="section-title"><i class="fas fa-clipboard-check"></i> Realizar Examen</h2>
                
                <!-- Acceso con c√≥digo -->
                <div class="card" id="accessSection">
                    <h3><i class="fas fa-key"></i> Acceso a Capacitaci√≥n</h3>
                    <p style="color: #666; margin-bottom: 1.5rem;">Ingresa el c√≥digo de acceso que recibiste para acceder a la capacitaci√≥n</p>
                    
                    <div class="form-group">
                        <label><i class="fas fa-barcode"></i> C√≥digo de Acceso *</label>
                        <input type="text" id="accessCode" placeholder="Ej: 3LZ5RV" style="text-transform: uppercase;">
                    </div>
                    
                    <button class="btn btn-primary" onclick="validateAndStartTraining()" style="width: 100%;">
                        <i class="fas fa-arrow-right"></i> Acceder a Capacitaci√≥n
                    </button>
                </div>
                
                <!-- √Årea de pretest (oculta inicialmente) -->
                <div id="pretestSection" style="display: none;">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3><i class="fas fa-book"></i> Evaluaci√≥n Previa (Pre-Test)</h3>
                            <button class="btn btn-light" onclick="cancelTraining()" style="margin: 0;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- Informaci√≥n de capacitaci√≥n -->
                        <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #2196F3;">
                            <p style="margin: 0;"><strong>Capacitaci√≥n:</strong> <span id="currentTrainingTitle">-</span></p>
                            <p style="margin: 0.5rem 0 0 0;"><strong>C√≥digo:</strong> <span id="currentAccessCode">-</span></p>
                        </div>
                        
                        <!-- Preguntas -->
                        <div id="pretestQuestionsContainer">
                            <!-- Se llena din√°micamente -->
                        </div>
                        
                        <!-- Bot√≥n enviar -->
                        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e0e0e0;">
                            <button class="btn btn-success" onclick="submitPretest()" style="width: 100%;">
                                <i class="fas fa-check"></i> Enviar Pre-Test
                            </button>
                        </div>
                    </div>
                </div>

                <!-- √Årea de posttest (oculta inicialmente) -->
                <div id="posttestSection" style="display: none;">
                    <div class="section-header">
                        <h2>
                            <i class="fas fa-star"></i>
                            <span>Post-Test</span>
                        </h2>
                        <p>Evaluaci√≥n despu√©s de la capacitaci√≥n</p>
                    </div>

                    <div class="questions-section">
                        <div id="posttestQuestionsContainer">
                            <!-- Preguntas del posttest -->
                        </div>

                        <!-- Bot√≥n enviar -->
                        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e0e0e0;">
                            <button class="btn btn-success" onclick="submitPosttest()" style="width: 100%;">
                                <i class="fas fa-check"></i> Enviar Post-Test
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="reports" class="tab-content">
                <h2 class="section-title"><i class="fas fa-chart-bar"></i> Reportes</h2>
                <div class="card">
                    <p style="text-align: center; padding: 2rem; color: #666;">
                        Estad√≠sticas y reportes de capacitaciones
                    </p>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2025 Hospital Susana L√≥pez de Valencia</p>
            <p>Desarrollado con ‚ù§Ô∏è por Ing. Paul Eduardo Mu√±oz Rodriguez</p>
        </footer>
    </div>

    <!-- QR Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>üì± C√≥digo QR de Acceso</h2>
            <div id="qrcode" class="qr-container"></div>
            <div class="access-info">
                <p><strong>C√≥digo:</strong> <span id="modalAccessCode"></span></p>
                <p><strong>Link:</strong> <span id="modalAccessLink"></span></p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="copyLink()">
                    <i class="fas fa-copy"></i> Copiar
                </button>
                <button class="btn btn-success" onclick="shareWhatsApp()">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </button>
                <button class="btn btn-info" onclick="downloadQR()">
                    <i class="fas fa-download"></i> Descargar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Registro de Participante -->
    <div id="participantRegistrationModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeParticipantModal()">&times;</span>
            <h2 style="text-align: center; margin-bottom: 0.5rem; color: var(--primary);">
                <i class="fas fa-user-plus"></i> Registro de Participante
            </h2>
            <p style="text-align: center; color: #666; margin-bottom: 1.5rem;">
                Por favor completa tu informaci√≥n para acceder a la capacitaci√≥n
            </p>
            
            <div class="form-group">
                <label><i class="fas fa-user"></i> Nombre Completo *</label>
                <input type="text" id="participantName" placeholder="Ej: Juan Garc√≠a L√≥pez" required>
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-hospital"></i> Servicio M√©dico (Departamento) *</label>
                <select id="participantDepartment" required>
                    <option value="">Seleccione su departamento...</option>
                    <option value="General">General</option>
                    <option value="Enfermer√≠a">Enfermer√≠a</option>
                    <option value="Medicina">Medicina</option>
                    <option value="Administraci√≥n">Administraci√≥n</option>
                    <option value="Laboratorio">Laboratorio</option>
                    <option value="Radiolog√≠a">Radiolog√≠a</option>
                    <option value="Urgencias">Urgencias</option>
                    <option value="UCI">UCI</option>
                    <option value="Quir√≥fano">Quir√≥fano</option>
                    <option value="Pediatr√≠a">Pediatr√≠a</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            
            <div class="modal-actions" style="flex-direction: column; gap: 0.75rem;">
                <button class="btn btn-success" onclick="proceedToPretest()" style="width: 100%;">
                    <i class="fas fa-check"></i> Continuar al Pre-Test
                </button>
                <button class="btn btn-light" onclick="closeParticipantModal()" style="width: 100%;">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="details-modal">
        <div class="details-content">
            <div class="details-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0;"><i class="fas fa-info-circle"></i> Detalles de Capacitaci√≥n</h2>
                    <button class="close" onclick="closeDetailsModal()" style="background: rgba(255,255,255,0.2); color: white; border: none; font-size: 2rem; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">&times;</button>
                </div>
            </div>
            <div class="details-body" id="detailsBody">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>
    </div>

    <script>
        // ==================== VARIABLES GLOBALES ====================
        let pretestQuestionCount = 0;
        let posttestQuestionCount = 0;
        const MAX_QUESTIONS = 10;
        
        // Variables para el flujo de pretest
        let currentAccessCode = null;
        let currentTrainingRecord = null;
        let currentParticipantData = {};
        let pretestAnswers = {};
        let posttestAnswers = {};
        
        // Variables para rastrear participaci√≥n
        let currentParticipationId = null;
        let currentSessionId = null;
        let postestCode = null;

        // ==================== FUNCIONES DE PARTICIPANTE ====================
        
        async function validateAndStartTraining() {
            const code = document.getElementById('accessCode').value.toUpperCase().trim();
            
            if (!code) {
                Swal.fire({
                    icon: 'warning',
                    title: 'C√≥digo Requerido',
                    text: 'Por favor ingresa el c√≥digo de acceso',
                    confirmButtonText: 'Entendido'
                });
                return;
            }
            
            try {
                Swal.fire({
                    title: 'Buscando capacitaci√≥n...',
                    text: 'Por favor espera',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });
                
                // Buscar todas las sesiones para debugging
                const allResponse = await fetch('/.netlify/functions/airtable-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'GET',
                        path: `/Sesiones`
                    })
                });
                
                const allData = await allResponse.json();
                console.log('üìã Todas las sesiones:', allData.records);
                
                // Buscar la sesi√≥n espec√≠fica
                let session = null;
                
                if (allData.success && allData.records) {
                    session = allData.records.find(s => {
                        const codigoAcceso = s.fields['C√≥digo Acceso'] || '';
                        const activa = s.fields['Activa'] !== false;
                        return codigoAcceso.toUpperCase() === code && activa;
                    });
                }
                
                if (!session) {
                    Swal.close();
                    Swal.fire({
                        icon: 'error',
                        title: 'C√≥digo Inv√°lido',
                        text: 'El c√≥digo "' + code + '" no existe o la sesi√≥n no est√° activa.\n\nVerifica en Airtable que:\n1. El c√≥digo exista en la tabla Sesiones\n2. El campo "Activa" est√© marcado ‚úÖ\n3. El c√≥digo sea exactamente: ' + code
                    });
                    return;
                }
                
                console.log('‚úÖ Sesi√≥n encontrada:', session);
                
                // Obtener ID de capacitaci√≥n - probar m√∫ltiples nombres de campos
                let trainingId = null;
                
                // Intentar diferentes nombres de campo
                if (session.fields['Capacitaciones'] && Array.isArray(session.fields['Capacitaciones']) && session.fields['Capacitaciones'].length > 0) {
                    trainingId = session.fields['Capacitaciones'][0];
                    console.log('‚úÖ Campo "Capacitaciones" encontrado');
                } else if (session.fields['Capacitaci√≥n'] && Array.isArray(session.fields['Capacitaci√≥n']) && session.fields['Capacitaci√≥n'].length > 0) {
                    trainingId = session.fields['Capacitaci√≥n'][0];
                    console.log('‚úÖ Campo "Capacitaci√≥n" encontrado');
                } else if (session.fields['capacitacion'] && Array.isArray(session.fields['capacitacion']) && session.fields['capacitacion'].length > 0) {
                    trainingId = session.fields['capacitacion'][0];
                    console.log('‚úÖ Campo "capacitacion" encontrado');
                }
                
                if (!trainingId) {
                    Swal.close();
                    console.error('‚ùå Campo de capacitaci√≥n vac√≠o:', session.fields);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de Configuraci√≥n',
                        html: `<p>La sesi√≥n con c√≥digo <strong>${code}</strong> no tiene capacitaci√≥n enlazada.</p>
                               <p><strong>En Airtable:</strong></p>
                               <p>1. Abre tabla "Sesiones"</p>
                               <p>2. Busca el registro con c√≥digo "${code}"</p>
                               <p>3. En el campo "Capacitaciones" (o "Capacitaci√≥n"), haz click y selecciona una capacitaci√≥n</p>
                               <p>4. Guarda y vuelve a intentar</p>`
                    });
                    return;
                }
                
                console.log('üéì ID de Capacitaci√≥n:', trainingId);
                
                // Obtener datos de la capacitaci√≥n
                const trainingResponse = await fetch('/.netlify/functions/airtable-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'GET',
                        path: `/Capacitaciones/${trainingId}`
                    })
                });
                
                const trainingData = await trainingResponse.json();
                
                console.log('üìö Datos de Capacitaci√≥n:', trainingData);
                
                if (!trainingData.success || !trainingData.fields) {
                    throw new Error('No se pudieron obtener los datos de la capacitaci√≥n');
                }
                
                // Guardar datos actuales
                currentAccessCode = code;
                currentTrainingRecord = {
                    id: trainingId,
                    fields: trainingData.fields
                };
                
                console.log('‚úÖ Datos guardados - ID de capacitaci√≥n:', trainingId);
                console.log('‚úÖ currentTrainingRecord:', currentTrainingRecord);
                
                Swal.close();
                
                // Mostrar modal de registro
                showParticipantRegistrationModal();
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                Swal.close();
                Swal.fire({
                    icon: 'error',
                    title: 'Error del Sistema',
                    text: 'Hubo un error: ' + error.message + '\n\nAbre DevTools (F12) para ver detalles'
                });
            }
        }
        
        function showParticipantRegistrationModal() {
            document.getElementById('participantRegistrationModal').style.display = 'flex';
        }
        
        function closeParticipantModal() {
            document.getElementById('participantRegistrationModal').style.display = 'none';
        }
        
        async function proceedToPretest() {
            const name = document.getElementById('participantName').value.trim();
            const department = document.getElementById('participantDepartment').value;
            
            if (!name) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Nombre Requerido',
                    text: 'Por favor ingresa tu nombre completo',
                    confirmButtonText: 'Entendido'
                });
                return;
            }
            
            if (!department) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Departamento Requerido',
                    text: 'Por favor selecciona tu departamento/servicio',
                    confirmButtonText: 'Entendido'
                });
                return;
            }
            
            // Guardar datos del participante
            currentParticipantData = {
                name: name,
                department: department,
                accessCode: currentAccessCode
            };
            
            // Cerrar modal y cargar pretest
            closeParticipantModal();
            loadAndDisplayPretest();
        }
        
        async function loadAndDisplayPretest() {
            try {
                Swal.fire({
                    title: 'Cargando evaluaci√≥n...',
                    text: 'Por favor espera',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });
                
                const trainingId = currentTrainingRecord.id;
                const trainingTitle = currentTrainingRecord.fields['name'] || currentTrainingRecord.fields['T√≠tulo'] || 'Capacitaci√≥n';
                
                console.log(`üîç Buscando preguntas para entrenamiento: ${trainingId} (${trainingTitle})`);
                
                // Obtener TODAS las preguntas primero
                const allQuestionsResponse = await fetch('/.netlify/functions/airtable-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'GET',
                        path: `/Preguntas`
                    })
                });
                
                const allQuestionsData = await allQuestionsResponse.json();
                
                console.log('üìö Todas las preguntas disponibles:', allQuestionsData.records?.length || 0);
                
                if (!allQuestionsData.success || !allQuestionsData.records) {
                    throw new Error('No se pudieron cargar las preguntas');
                }
                
                // IMPORTANTE: Obtener el trainingId correcto de la sesi√≥n
                const trainingId = currentTrainingRecord.id;
                console.log('üéì Training ID de la sesi√≥n:', trainingId);
                console.log('üìã Registro de capacitaci√≥n actual:', currentTrainingRecord);
                
                // Filtrar preguntas en JavaScript - m√°s robusto
                const pretestQuestions = allQuestionsData.records.filter(q => {
                    const fields = q.fields;
                    
                    // Obtener el tipo de pregunta (intentar diferentes nombres)
                    const tipo = fields['Tipo Examen'] || fields['Tipo'] || fields['tipo'] || fields['Type'] || '';
                    
                    // Verificar si es pretest (case-insensitive)
                    const isPretest = tipo.toLowerCase() === 'pretest' || tipo.toLowerCase() === 'pre-test' || tipo.toLowerCase() === 'pre test';
                    
                    // Obtener capacitaci√≥n (intentar diferentes nombres)
                    let capacitacionId = null;
                    
                    if (fields['Capacitaci√≥n'] && Array.isArray(fields['Capacitaci√≥n'])) {
                        capacitacionId = fields['Capacitaci√≥n'][0];
                    } else if (fields['Capacitaciones'] && Array.isArray(fields['Capacitaciones'])) {
                        capacitacionId = fields['Capacitaciones'][0];
                    } else if (fields['capacitacion'] && Array.isArray(fields['capacitacion'])) {
                        capacitacionId = fields['capacitacion'][0];
                    } else if (fields['capacitaciones'] && Array.isArray(fields['capacitaciones'])) {
                        capacitacionId = fields['capacitaciones'][0];
                    }
                    
                    const isMatch = isPretest && capacitacionId === trainingId;
                    
                    if (!isMatch) {
                        console.log(`‚úó Pregunta NO match: "${fields['Pregunta'] || 'Sin nombre'}" | Tipo: "${tipo}" | CapID: "${capacitacionId}" vs "${trainingId}"`);
                    }
                    
                    return isMatch;
                });
                
                console.log(`‚úÖ Preguntas de pretest encontradas: ${pretestQuestions.length}`);
                
                Swal.close();
                
                // Mostrar interfaz de pretest
                displayPretestQuestions(pretestQuestions);
                
                // Ocultar secci√≥n de acceso, mostrar pretest
                document.getElementById('accessSection').style.display = 'none';
                document.getElementById('pretestSection').style.display = 'block';
                
                // Actualizar informaci√≥n de capacitaci√≥n
                document.getElementById('currentTrainingTitle').textContent = trainingTitle;
                document.getElementById('currentAccessCode').textContent = currentAccessCode;
                
            } catch (error) {
                console.error('‚ùå Error cargando pretest:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error Cargando Pretest',
                    text: 'No se pudieron cargar las preguntas del pretest: ' + error.message + '\n\nAbre DevTools (F12) para ver detalles'
                });
            }
        }
        
        function displayPretestQuestions(questions) {
            const container = document.getElementById('pretestQuestionsContainer');
            container.innerHTML = '';
            
            if (!questions || questions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; background: #fff3cd; border-radius: 8px; border: 2px solid #ffc107;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #ff9800; margin-bottom: 1rem; display: block;"></i>
                        <p style="color: #666; margin: 0; font-size: 1.1rem;">
                            <strong>‚ö†Ô∏è No hay preguntas de pretest configuradas</strong>
                        </p>
                        <p style="color: #999; margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                            En Airtable, crea preguntas con Tipo = "Pretest" enlazadas a esta capacitaci√≥n
                        </p>
                    </div>
                `;
                return;
            }
            
            questions.forEach((question, index) => {
                const fields = question.fields;
                const questionNumber = index + 1;
                const questionId = `pretest-q${question.id}`;
                
                // Buscar el nombre de la pregunta (intentar diferentes campos)
                const questionText = fields['name'] || fields['Nombre'] || fields['Pregunta'] || fields['T√≠tulo'] || 'Sin pregunta';
                
                // Obtener opciones (intentar variaciones de nombres)
                const options = [
                    { letter: 'A', text: fields['Opci√≥n A'] || fields['opci√≥n a'] || fields['Option A'] || fields['A'] || '' },
                    { letter: 'B', text: fields['Opci√≥n B'] || fields['opci√≥n b'] || fields['Option B'] || fields['B'] || '' },
                    { letter: 'C', text: fields['Opci√≥n C'] || fields['opci√≥n c'] || fields['Option C'] || fields['C'] || '' },
                    { letter: 'D', text: fields['Opci√≥n D'] || fields['opci√≥n d'] || fields['Option D'] || fields['D'] || '' }
                ].filter(opt => opt.text && opt.text.trim());
                
                // Si no hay opciones, intentar b√∫squeda m√°s amplia
                if (options.length === 0) {
                    console.warn(`‚ö†Ô∏è Pregunta ${questionNumber} no tiene opciones configuradas:`, fields);
                }
                
                const questionHTML = `
                    <div class="question-card" style="margin-bottom: 1.5rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--primary);">
                        <h4 style="margin-top: 0; color: var(--primary); margin-bottom: 0.75rem;">
                            <i class="fas fa-question-circle"></i> Pregunta ${questionNumber} / ${questions.length}
                        </h4>
                        <p style="margin: 0 0 1rem 0; font-weight: 500; color: #333; font-size: 1.05rem;">
                            ${questionText}
                        </p>
                        
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            ${options.length > 0 ? options.map(option => `
                                <label style="display: flex; align-items: flex-start; padding: 0.75rem; background: white; border-radius: 6px; cursor: pointer; transition: all 0.3s; border: 2px solid #e0e0e0; hover: border-color: var(--primary);">
                                    <input type="radio" 
                                           name="${questionId}" 
                                           value="${option.letter}" 
                                           onchange="pretestAnswers['${question.id}'] = this.value"
                                           style="width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); margin-top: 2px; flex-shrink: 0;">
                                    <span style="margin-left: 0.75rem; flex: 1;">
                                        <strong style="color: var(--primary);">${option.letter})</strong> <span style="color: #333;">${option.text}</span>
                                    </span>
                                </label>
                            `).join('') : '<p style="color: #f44336; font-weight: bold;">‚ö†Ô∏è Sin opciones de respuesta</p>'}
                        </div>
                    </div>
                `;
                
                container.innerHTML += questionHTML;
            });
        }
        
        async function submitPretest() {
            const answers = Object.keys(pretestAnswers).length;
            const questionCards = document.querySelectorAll('.question-card');
            const totalQuestions = questionCards.length;
            
            // Validar que se hayan respondido todas las preguntas
            if (answers === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Respuestas Incompletas',
                    text: 'Por favor responde todas las preguntas antes de enviar'
                });
                return;
            }
            
            if (answers < totalQuestions) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Respuestas Incompletas',
                    text: `Has respondido ${answers} de ${totalQuestions} preguntas. Por favor completa todas antes de enviar`
                });
                return;
            }
            
            try {
                Swal.fire({
                    title: 'Enviando Pre-Test...',
                    text: 'Por favor espera mientras guardamos tu evaluaci√≥n',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });
                
                console.log('üìù Iniciando proceso de guardado del pretest...');
                console.log('üë§ Participante:', currentParticipantData);
                console.log('üìã Respuestas:', pretestAnswers);
                
                // ==========================================
                // PASO 1: Buscar la sesi√≥n actual
                // ==========================================
                
                const sessionResponse = await fetch('/.netlify/functions/airtable-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'GET',
                        path: `/Sesiones`
                    })
                });
                
                const sessionData = await sessionResponse.json();
                
                if (!sessionData.success || !sessionData.records) {
                    throw new Error('No se pudieron obtener las sesiones');
                }
                
                // Encontrar la sesi√≥n por c√≥digo de acceso
                const currentSession = sessionData.records.find(s => {
                    const codigo = s.fields['C√≥digo Acceso'] || '';
                    return codigo.toUpperCase() === currentAccessCode.toUpperCase();
                });
                
                if (!currentSession) {
                    throw new Error('No se encontr√≥ la sesi√≥n con c√≥digo: ' + currentAccessCode);
                }
                
                console.log('‚úÖ Sesi√≥n encontrada:', currentSession.id);
                
                // ==========================================
                // PASO 2: Obtener preguntas para calcular score
                // ==========================================
                
                const questionsResponse = await fetch('/.netlify/functions/airtable-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'GET',
                        path: `/Preguntas`
                    })
                });
                
                const questionsData = await questionsResponse.json();
                
                if (!questionsData.success || !questionsData.records) {
                    throw new Error('No se pudieron obtener las preguntas');
                }
                
                // ==========================================
                // PASO 3: Calcular el score del pretest
                // ==========================================
                
                let correctAnswers = 0;
                let totalAnswered = 0;
                const answersToSave = [];
                
                for (const [questionId, userAnswer] of Object.entries(pretestAnswers)) {
                    // Buscar la pregunta en los registros
                    const question = questionsData.records.find(q => q.id === questionId);
                    
                    if (question) {
                        totalAnswered++;
                        
                        // Obtener la respuesta correcta (intentar diferentes nombres de campo)
                        const correctAnswer = question.fields['Respuesta Correcta'] || 
                                             question.fields['Respuesta correcta'] || 
                                             question.fields['RespuestaCorrecta'] ||
                                             question.fields['Correct Answer'] ||
                                             question.fields['correct_answer'] || '';
                        
                        // Comparar respuestas (case-insensitive)
                        const isCorrect = userAnswer.toUpperCase() === correctAnswer.toUpperCase();
                        
                        if (isCorrect) {
                            correctAnswers++;
                        }
                        
                        console.log(`Pregunta ${questionId}: Usuario=${userAnswer}, Correcta=${correctAnswer}, ‚úì=${isCorrect}`);
                        
                        // Preparar respuesta para guardar
                        answersToSave.push({
                            questionId: questionId,
                            userAnswer: userAnswer,
                            isCorrect: isCorrect
                        });
                    }
                }
                
                // Calcular porcentaje de score (escala de 0 a 100)
                const pretestScore = totalAnswered > 0 
                    ? Math.round((correctAnswers / totalAnswered) * 100) 
                    : 0;
                
                console.log(`üìä Score calculado: ${correctAnswers}/${totalAnswered} = ${pretestScore}%`);
                
                // ==========================================
                // PASO 4: Crear registro de participaci√≥n (LISTA DE ASISTENCIA)
                // ==========================================
                
                // ‚úÖ CORREGIDO: Generar fecha y hora en formato correcto
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                
                // Formato: YYYY-MM-DD HH:mm:ss (compatible con campos Date en Airtable)
                const fechaFormato = `${year}-${month}-${day}`;
                const horaFormato = `${hours}:${minutes}:${seconds}`;
                const fechaHoraCompleta = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                
                const participationData = {
                    fields: {
                        'Nombre': currentParticipantData.name,
                        'Departamento': currentParticipantData.department,
                        'Sesi√≥n': [currentSession.id],
                        'Pretest Score': pretestScore,
                        'Fecha Registro': fechaFormato,  // Solo fecha: 2025-11-20
                        'Hora Registro': fechaHoraCompleta,  // ‚úÖ CORREGIDO: Fecha y hora completa
                        'Completado Pretest': true,
                        'Completado Posttest': false
                    }
                };
                
                console.log('üì§ Creando participaci√≥n:', participationData);
                
                const createParticipationResponse = await fetch('/.netlify/functions/airtable-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'POST',
                        path: `/Participaciones`,
                        body: participationData
                    })
                });
                
                const participationResult = await createParticipationResponse.json();
                
                if (!participationResult.success) {
                    console.error('‚ùå Error creando participaci√≥n:', participationResult);
                    throw new Error(participationResult.error || 'No se pudo crear el registro de participaci√≥n');
                }
                
                console.log('‚úÖ Participaci√≥n creada:', participationResult.id);
                
                // ==========================================
                // PASO 5: Guardar respuestas individuales (opcional)
                // ==========================================
                
                const participationId = participationResult.id;
                
                // Guardar cada respuesta en la tabla Respuestas
                for (const answer of answersToSave) {
                    try {
                        const answerData = {
                            fields: {
                                'Participaci√≥n': [participationId],
                                'Pregunta': [answer.questionId],
                                'Respuesta Usuario': answer.userAnswer,
                                'Es Correcta': answer.isCorrect,
                                'Tipo Examen': 'Pretest'
                            }
                        };
                        
                        await fetch('/.netlify/functions/airtable-proxy', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                method: 'POST',
                                path: `/Respuestas`,
                                body: answerData
                            })
                        });
                        
                        console.log(`‚úÖ Respuesta guardada para pregunta: ${answer.questionId}`);
                        
                    } catch (answerError) {
                        console.warn(`‚ö†Ô∏è No se pudo guardar respuesta individual:`, answerError);
                        // Continuar con las dem√°s respuestas aunque una falle
                    }
                }
                
                // ==========================================
                // PASO 6: Mostrar resultado al usuario
                // ==========================================
                
                Swal.close();
                
                // Determinar el mensaje seg√∫n el score
                let scoreMessage = '';
                let scoreIcon = 'success';
                
                if (pretestScore >= 80) {
                    scoreMessage = '¬°Excelente conocimiento previo!';
                } else if (pretestScore >= 60) {
                    scoreMessage = 'Buen nivel de conocimiento';
                } else if (pretestScore >= 40) {
                    scoreMessage = 'Conocimiento b√°sico';
                } else {
                    scoreMessage = 'Esta capacitaci√≥n ser√° muy √∫til para ti';
                    scoreIcon = 'info';
                }
                
                Swal.fire({
                    icon: scoreIcon,
                    title: '¬°Pre-Test Enviado!',
                    html: `
                        <div style="text-align: center;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                        color: white; 
                                        padding: 1.5rem; 
                                        border-radius: 12px; 
                                        margin-bottom: 1rem;">
                                <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Tu calificaci√≥n</p>
                                <p style="margin: 0.5rem 0; font-size: 2.5rem; font-weight: bold;">${pretestScore}%</p>
                                <p style="margin: 0; font-size: 0.85rem;">${correctAnswers} de ${totalAnswered} correctas</p>
                            </div>
                            
                            <p style="margin: 0.5rem 0;"><strong>${currentParticipantData.name}</strong></p>
                            <p style="margin: 0; color: #666; font-size: 0.9rem;">${currentParticipantData.department}</p>
                            <p style="margin: 1rem 0 0 0; color: #666; font-size: 0.9rem;">${scoreMessage}</p>
                            <p style="margin: 0.5rem 0 0 0; color: #999; font-size: 0.8rem;">
                                Tu asistencia y calificaci√≥n han sido registradas
                            </p>
                        </div>
                    `,
                    confirmButtonText: 'Continuar a la Capacitaci√≥n',
                    showCancelButton: true,
                    cancelButtonText: 'Volver al Inicio',
                    confirmButtonColor: '#667eea'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // GUARDAR participationId para uso posterior en posttest
                        currentParticipationId = participationResult.id;
                        currentSessionId = currentSession.id;
                        
                        Swal.fire({
                            icon: 'info',
                            title: 'Contenido de Capacitaci√≥n',
                            text: 'El coordinador compartir√° el contenido de la capacitaci√≥n. Una vez finalizado, podr√°s realizar el Post-Test.',
                            confirmButtonText: 'Entendido'
                        }).then(() => {
                            // Mostrar bot√≥n para acceder al posttest
                            showPostestButton();
                        });
                    } else {
                        // Volver al inicio
                        cancelTraining();
                    }
                });
                
                console.log('‚úÖ Proceso de pretest completado exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error enviando pretest:', error);
                Swal.close();
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo enviar el pretest: ' + error.message,
                    footer: '<small>Revisa la consola (F12) para m√°s detalles</small>'
                });
            }
        }
        
        // ==================== FUNCIONES DE POSTTEST ====================
        
        function showPostestButton() {
            // Ocultar secci√≥n de pretest
            document.getElementById('pretestSection').style.display = 'none';
            document.getElementById('accessSection').style.display = 'none';
            
            // Mostrar mensaje de espera
            Swal.fire({
                icon: 'info',
                title: 'Esperando acceso al Post-Test',
                html: `
                    <div style="text-align: center; padding: 1rem;">
                        <p style="margin-bottom: 1rem;">¬øYa terminaste la capacitaci√≥n?</p>
                        <button class="btn btn-success" onclick="loadPosttest()" style="width: 100%; padding: 0.75rem; font-size: 1rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-arrow-right"></i> Continuar al Post-Test
                        </button>
                        <button class="btn btn-secondary" onclick="cancelTraining()" style="width: 100%; padding: 0.75rem; font-size: 0.9rem;">
                            <i class="fas fa-times"></i> Salir
                        </button>
                    </div>
                `,
                allowOutsideClick: false,
                showConfirmButton: false
            });
        }
        
        async function loadPosttest() {
            try {
                Swal.close();
                Swal.fire({
                    title: 'Cargando Post-Test...',
                    text: 'Por favor espera',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });
                
                // Obtener preguntas de posttest
                const questionsResponse = await fetch('/.netlify/functions/airtable-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'GET',
                        path: `/Preguntas`
                    })
                });
                
                const questionsData = await questionsResponse.json();
                
                if (!questionsData.success || !questionsData.records) {
                    throw new Error('No se pudieron obtener las preguntas del posttest');
                }
                
                // Filtrar preguntas de posttest
                const trainingIdForFilter = currentTrainingRecord.id;
                console.log('üéì Buscando preguntas posttest para capacitaci√≥n ID:', trainingIdForFilter);
                
                const posttestQuestions = questionsData.records.filter(q => {
                    const capacitacionLinks = q.fields['Capacitaciones'] || [];
                    const tipoExamen = q.fields['Tipo Examen'] || '';
                    
                    const isCorrectTraining = capacitacionLinks.includes(trainingIdForFilter);
                    const isPostest = tipoExamen.toLowerCase() === 'posttest' || 
                                      tipoExamen.toLowerCase() === 'post-test' || 
                                      tipoExamen.toLowerCase() === 'post test';
                    
                    if (!isCorrectTraining || !isPostest) {
                        console.log(`‚úó Pregunta NO match: "${q.fields['Pregunta'] || 'Sin nombre'}" | Tipo: "${tipoExamen}" | CapLinks: [${capacitacionLinks.join(',')}]`);
                    }
                    
                    return isCorrectTraining && isPostest;
                });
                
                console.log(`‚úÖ Preguntas de posttest encontradas: ${posttestQuestions.length}`);
                
                if (posttestQuestions.length === 0) {
                    throw new Error('No hay preguntas de posttest configuradas');
                }
                
                // Limpiar respuestas anteriores
                posttestAnswers = {};
                
                // Mostrar interfaz de posttest
                displayPosttestQuestions(posttestQuestions);
                
                // Ocultar modal y mostrar secci√≥n de posttest
                Swal.close();
                document.getElementById('posttestSection').style.display = 'block';
                document.getElementById('accessSection').style.display = 'none';
                document.getElementById('pretestSection').style.display = 'none';
                
            } catch (error) {
                console.error('‚ùå Error cargando posttest:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo cargar el posttest: ' + error.message
                }).then(() => {
                    showPostestButton();
                });
            }
        }
        
        function displayPosttestQuestions(questions) {
            const container = document.getElementById('posttestQuestionsContainer');
            container.innerHTML = '';
            
            if (questions.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è No hay preguntas de posttest configuradas</strong>
                    </div>
                `;
                return;
            }
            
            questions.forEach((question, index) => {
                const questionId = question.id;
                const questionText = question.fields['Pregunta'] || 'Pregunta sin texto';
                const options = question.fields['Opciones'] || [];
                
                const questionEl = document.createElement('div');
                questionEl.className = 'question-card';
                
                let optionsHTML = '';
                const optionLetters = ['A', 'B', 'C', 'D'];
                
                options.forEach((option, idx) => {
                    optionsHTML += `
                        <label class="option">
                            <input type="radio" 
                                   name="posttest-q${questionId}" 
                                   value="${optionLetters[idx]}"
                                   onchange="posttestAnswers['${questionId}'] = this.value"
                            >
                            <span class="option-letter">${optionLetters[idx]}</span>
                            <span class="option-text">${option}</span>
                        </label>
                    `;
                });
                
                questionEl.innerHTML = `
                    <div class="question-header">
                        <span class="question-number">Pregunta ${index + 1} / ${questions.length}</span>
                    </div>
                    <p class="question-text">${questionText}</p>
                    <div class="options">
                        ${optionsHTML}
                    </div>
                `;
                
                container.appendChild(questionEl);
            });
        }
        
        async function submitPosttest() {
            const answers = Object.keys(posttestAnswers).length;
            const questionCards = document.querySelectorAll('#posttestSection .question-card');
            const totalQuestions = questionCards.length;
            
            // Validar que se hayan respondido todas las preguntas
            if (answers === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Respuestas Incompletas',
                    text: 'Por favor responde todas las preguntas antes de enviar'
                });
                return;
            }
            
            if (answers < totalQuestions) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Respuestas Incompletas',
                    text: `Has respondido ${answers} de ${totalQuestions} preguntas. Por favor completa todas antes de enviar`
                });
                return;
            }
            
            try {
                Swal.fire({
                    title: 'Enviando Post-Test...',
                    text: 'Por favor espera mientras guardamos tu evaluaci√≥n',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });
                
                console.log('üìù Iniciando proceso de guardado del posttest...');
                console.log('üë§ Participante:', currentParticipantData);
                console.log('üìã Respuestas:', posttestAnswers);
                
                // ==========================================
                // PASO 1: Obtener preguntas para calcular score
                // ==========================================
                
                const questionsResponse = await fetch('/.netlify/functions/airtable-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'GET',
                        path: `/Preguntas`
                    })
                });
                
                const questionsData = await questionsResponse.json();
                
                if (!questionsData.success || !questionsData.records) {
                    throw new Error('No se pudieron obtener las preguntas');
                }
                
                // ==========================================
                // PASO 2: Calcular el score del posttest
                // ==========================================
                
                let correctAnswers = 0;
                let totalAnswered = 0;
                const answersToSave = [];
                
                for (const [questionId, userAnswer] of Object.entries(posttestAnswers)) {
                    const question = questionsData.records.find(q => q.id === questionId);
                    
                    if (question) {
                        totalAnswered++;
                        
                        const correctAnswer = question.fields['Respuesta Correcta'] || 
                                             question.fields['Respuesta correcta'] || 
                                             question.fields['RespuestaCorrecta'] ||
                                             question.fields['Correct Answer'] ||
                                             question.fields['correct_answer'] || '';
                        
                        const isCorrect = userAnswer.toUpperCase() === correctAnswer.toUpperCase();
                        
                        if (isCorrect) {
                            correctAnswers++;
                        }
                        
                        console.log(`Pregunta ${questionId}: Usuario=${userAnswer}, Correcta=${correctAnswer}, ‚úì=${isCorrect}`);
                        
                        answersToSave.push({
                            questionId: questionId,
                            userAnswer: userAnswer,
                            isCorrect: isCorrect
                        });
                    }
                }
                
                const posttestScore = totalAnswered > 0 
                    ? Math.round((correctAnswers / totalAnswered) * 100) 
                    : 0;
                
                console.log(`üìä Score calculado: ${correctAnswers}/${totalAnswered} = ${posttestScore}%`);
                
                // ==========================================
                // PASO 3: Actualizar registro de participaci√≥n
                // ==========================================
                
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                
                const fechaFormato = `${year}-${month}-${day}`;
                const horaFormato = `${hours}:${minutes}:${seconds}`;
                const fechaHoraCompleta = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                
                const updateParticipationResponse = await fetch('/.netlify/functions/airtable-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'PATCH',
                        path: `/Participaciones/${currentParticipationId}`,
                        body: {
                            fields: {
                                'Posttest Score': posttestScore,
                                'Fecha Posttest': fechaFormato,
                                'Hora Posttest': fechaHoraCompleta,
                                'Completado Posttest': true,
                                'Estado': 'Completado'
                            }
                        }
                    })
                });
                
                const updateParticipationData = await updateParticipationResponse.json();
                
                if (!updateParticipationData.success) {
                    console.error('‚ùå Error actualizando participaci√≥n:', updateParticipationData);
                    throw new Error(updateParticipationData.error || 'No se pudo actualizar el registro');
                }
                
                console.log('‚úÖ Participaci√≥n actualizada:', currentParticipationId);
                
                // ==========================================
                // PASO 4: Guardar respuestas individuales
                // ==========================================
                
                for (const answer of answersToSave) {
                    try {
                        const answerData = {
                            fields: {
                                'Participaci√≥n': [currentParticipationId],
                                'Pregunta': [answer.questionId],
                                'Respuesta Usuario': answer.userAnswer,
                                'Es Correcta': answer.isCorrect,
                                'Tipo Examen': 'Posttest'
                            }
                        };
                        
                        await fetch('/.netlify/functions/airtable-proxy', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                method: 'POST',
                                path: `/Respuestas`,
                                body: answerData
                            })
                        });
                        
                        console.log(`‚úÖ Respuesta guardada para pregunta: ${answer.questionId}`);
                        
                    } catch (answerError) {
                        console.warn(`‚ö†Ô∏è No se pudo guardar respuesta individual:`, answerError);
                    }
                }
                
                // ==========================================
                // PASO 5: Mostrar resultado al usuario
                // ==========================================
                
                Swal.close();
                
                let scoreMessage = '';
                let scoreIcon = 'success';
                let congratsMessage = '¬°Felicidades!';
                
                if (posttestScore >= 80) {
                    scoreMessage = '¬°Excelente desempe√±o!';
                    congratsMessage = '¬°Demostraste un excelente dominio del tema!';
                } else if (posttestScore >= 60) {
                    scoreMessage = 'Buen desempe√±o';
                    congratsMessage = '¬°Aplicaste muy bien lo aprendido!';
                } else if (posttestScore >= 40) {
                    scoreMessage = 'Desempe√±o regular';
                    congratsMessage = 'Contin√∫a practicando para mejorar';
                } else {
                    scoreMessage = 'Es momento de reforzar el aprendizaje';
                    scoreIcon = 'warning';
                    congratsMessage = 'Te recomendamos revisar el contenido nuevamente';
                }
                
                Swal.fire({
                    icon: scoreIcon,
                    title: congratsMessage,
                    html: `
                        <div style="text-align: center;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                        color: white; 
                                        padding: 1.5rem; 
                                        border-radius: 12px; 
                                        margin-bottom: 1rem;">
                                <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Tu calificaci√≥n en Post-Test</p>
                                <p style="margin: 0.5rem 0; font-size: 2.5rem; font-weight: bold;">${posttestScore}%</p>
                                <p style="margin: 0; font-size: 0.85rem;">${correctAnswers} de ${totalAnswered} correctas</p>
                            </div>
                            
                            <p style="margin: 0.5rem 0;"><strong>${currentParticipantData.name}</strong></p>
                            <p style="margin: 0; color: #666; font-size: 0.9rem;">${currentParticipantData.department}</p>
                            <p style="margin: 1rem 0 0 0; color: #666; font-size: 0.9rem;">${scoreMessage}</p>
                            <p style="margin: 0.5rem 0 0 0; color: #999; font-size: 0.8rem;">
                                Tu evaluaci√≥n ha sido completada y registrada
                            </p>
                        </div>
                    `,
                    confirmButtonText: 'Volver al Inicio',
                    confirmButtonColor: '#667eea',
                    allowOutsideClick: false
                }).then(() => {
                    cancelTraining();
                });
                
                console.log('‚úÖ Proceso de posttest completado exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error enviando posttest:', error);
                Swal.close();
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo enviar el posttest: ' + error.message,
                    footer: '<small>Revisa la consola (F12) para m√°s detalles</small>'
                });
            }
        }
        
        function cancelTraining() {
            // Limpiar datos
            currentAccessCode = null;
            currentTrainingRecord = null;
            currentParticipantData = {};
            pretestAnswers = {};
            posttestAnswers = {};
            currentParticipationId = null;
            currentSessionId = null;
            postestCode = null;
            
            // Limpiar formulario
            document.getElementById('accessCode').value = '';
            document.getElementById('participantName').value = '';
            document.getElementById('participantDepartment').value = '';
            
            // Mostrar/ocultar secciones
            document.getElementById('accessSection').style.display = 'block';
            document.getElementById('pretestSection').style.display = 'none';
            document.getElementById('posttestSection').style.display = 'none';
        }


        // ==================== INICIALIZACI√ìN ====================
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            updateDateTime();
            setInterval(updateDateTime, 1000);
        });

        function initializeApp() {
            setTimeout(() => {
                document.getElementById('loadingScreen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                }, 500);
            }, 1500);

            setTimeout(() => initializeCharts(), 2000);
            
            // Cargar capacitaciones al inicio (sin mostrar, solo en background)
            setTimeout(() => loadTrainings(), 2500);
            
            // Verificar si viene con c√≥digo QR en la URL
            checkForAccessCode();
        }
        
        function checkForAccessCode() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const auto = urlParams.get('auto'); // Par√°metro para crear sesi√≥n autom√°ticamente
            
            if (code) {
                setTimeout(() => {
                    // Si tiene par√°metro auto=true, intentar crear sesi√≥n autom√°ticamente
                    if (auto === 'true') {
                        createSessionAutomatically(code);
                    } else {
                        // Comportamiento normal: solo auto-llenar el c√≥digo
                        document.getElementById('accessCode').value = code;
                        switchTab('exam');
                    }
                }, 1000);
            }
        }

        // ==================== NUEVA FUNCI√ìN: CREAR SESI√ìN AUTOM√ÅTICAMENTE ====================
        
        async function createSessionAutomatically(code) {
            try {
                Swal.fire({
                    title: 'Preparando capacitaci√≥n...',
                    text: 'Por favor espera',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                console.log(`üì± Intentando crear sesi√≥n autom√°ticamente para c√≥digo: ${code}`);

                // Paso 1: Obtener la primera capacitaci√≥n disponible
                const trainingResponse = await fetch('/.netlify/functions/airtable-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'GET',
                        path: `/Capacitaciones?maxRecords=1`
                    })
                });

                const trainingData = await trainingResponse.json();

                if (!trainingData.success || !trainingData.records || trainingData.records.length === 0) {
                    throw new Error('No hay capacitaciones disponibles en el sistema');
                }

                const trainingId = trainingData.records[0].id;
                console.log(`üéì Capacitaci√≥n encontrada: ${trainingId}`);

                // Paso 2: Llamar a la funci√≥n serverless para crear sesi√≥n
                const createResponse = await fetch('/.netlify/functions/create-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: code,
                        trainingId: trainingId
                    })
                });

                const createData = await createResponse.json();

                console.log(`üìù Respuesta del servidor:`, createData);

                if (!createData.success) {
                    throw new Error(createData.error || 'No se pudo crear la sesi√≥n');
                }

                Swal.close();

                // Mostrar mensaje de √©xito
                Swal.fire({
                    icon: 'success',
                    title: '¬°Sesi√≥n Creada!',
                    text: `La sesi√≥n con c√≥digo ${code} ha sido creada autom√°ticamente`,
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    // Proceder con el flujo normal
                    document.getElementById('accessCode').value = code;
                    switchTab('exam');
                    
                    // Esperar a que se vea el input actualizado
                    setTimeout(() => {
                        validateAndStartTraining();
                    }, 500);
                });

            } catch (error) {
                console.error('‚ùå Error creando sesi√≥n autom√°ticamente:', error);
                Swal.close();
                
                Swal.fire({
                    icon: 'warning',
                    title: 'Crear Sesi√≥n Manualmente',
                    text: 'La sesi√≥n no pudo crearse autom√°ticamente.\n\n' + error.message + '\n\nPor favor, ingresa el c√≥digo manualmente o contacta al coordinador.',
                    confirmButtonText: 'Continuar'
                }).then(() => {
                    // Volver a flujo manual
                    document.getElementById('accessCode').value = code;
                    switchTab('exam');
                });
            }
        }

        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            const element = document.getElementById('currentDateTime');
            if (element) {
                element.textContent = now.toLocaleDateString('es-ES', options);
            }
        }

        function switchTab(tabName, event = null) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) selectedTab.classList.add('active');
            
            // Si hay un evento, marcar el bot√≥n clickeado como activo
            if (event && event.target) {
                const navTab = event.target.closest('.nav-tab');
                if (navTab) navTab.classList.add('active');
            } else {
                // Si no hay evento, buscar el bot√≥n correspondiente por data-tab
                const navTab = document.querySelector(`[data-tab="${tabName}"]`);
                if (navTab) navTab.classList.add('active');
            }
        }

        // ==================== FUNCIONES DE PREGUNTAS ====================
        
        function addQuestion(type) {
            const container = document.getElementById(`${type}Questions`);
            const currentCount = type === 'pretest' ? pretestQuestionCount : posttestQuestionCount;
            
            if (currentCount >= MAX_QUESTIONS) {
                Swal.fire({
                    icon: 'warning',
                    title: 'L√≠mite Alcanzado',
                    text: `Solo puedes agregar hasta ${MAX_QUESTIONS} preguntas por test`,
                    confirmButtonText: 'Entendido'
                });
                return;
            }
            
            if (type === 'pretest') {
                pretestQuestionCount++;
            } else {
                posttestQuestionCount++;
            }
            
            const questionNumber = currentCount + 1;
            const questionId = `${type}-q${questionNumber}`;
            
            const questionHTML = `
                <div class="question-card" id="${questionId}" data-question-number="${questionNumber}">
                    <div class="question-header">
                        <h4>üìù Pregunta ${questionNumber}</h4>
                        <button type="button" class="btn-remove" onclick="removeQuestion('${questionId}', '${type}')">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-question"></i> Pregunta *</label>
                        <textarea id="${questionId}-text" class="question-text" rows="2" required 
                                  placeholder="Escriba la pregunta aqu√≠..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-list"></i> Opciones de Respuesta</label>
                        <div class="options-container">
                            <div class="option-item">
                                <input type="radio" name="${questionId}-correct" value="a" id="${questionId}-option-a" required>
                                <label for="${questionId}-option-a" class="radio-label">‚úì Correcta</label>
                                <input type="text" id="${questionId}-text-a" class="option-text" placeholder="Opci√≥n A" required>
                            </div>
                            
                            <div class="option-item">
                                <input type="radio" name="${questionId}-correct" value="b" id="${questionId}-option-b">
                                <label for="${questionId}-option-b" class="radio-label">‚úì Correcta</label>
                                <input type="text" id="${questionId}-text-b" class="option-text" placeholder="Opci√≥n B" required>
                            </div>
                            
                            <div class="option-item">
                                <input type="radio" name="${questionId}-correct" value="c" id="${questionId}-option-c">
                                <label for="${questionId}-option-c" class="radio-label">‚úì Correcta</label>
                                <input type="text" id="${questionId}-text-c" class="option-text" placeholder="Opci√≥n C" required>
                            </div>
                            
                            <div class="option-item">
                                <input type="radio" name="${questionId}-correct" value="d" id="${questionId}-option-d">
                                <label for="${questionId}-option-d" class="radio-label">‚úì Correcta</label>
                                <input type="text" id="${questionId}-text-d" class="option-text" placeholder="Opci√≥n D" required>
                            </div>
                        </div>
                        <small class="help-text">Marca la opci√≥n correcta</small>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', questionHTML);
            updateQuestionCounter(type);
            
            // Animaci√≥n
            const newQuestion = document.getElementById(questionId);
            newQuestion.style.opacity = '0';
            setTimeout(() => {
                newQuestion.style.transition = 'opacity 0.3s';
                newQuestion.style.opacity = '1';
            }, 10);
        }

        function removeQuestion(questionId, type) {
            Swal.fire({
                title: '¬øEliminar pregunta?',
                text: 'Esta acci√≥n no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    const element = document.getElementById(questionId);
                    if (element) {
                        element.style.transition = 'opacity 0.3s';
                        element.style.opacity = '0';
                        
                        setTimeout(() => {
                            element.remove();
                            
                            if (type === 'pretest') {
                                pretestQuestionCount--;
                            } else {
                                posttestQuestionCount--;
                            }
                            
                            renumberQuestions(type);
                            updateQuestionCounter(type);
                        }, 300);
                    }
                }
            });
        }

        function renumberQuestions(type) {
            const container = document.getElementById(`${type}Questions`);
            const questions = container.querySelectorAll('.question-card');
            
            questions.forEach((question, index) => {
                const newNumber = index + 1;
                const header = question.querySelector('h4');
                if (header) {
                    header.textContent = `üìù Pregunta ${newNumber}`;
                }
                question.setAttribute('data-question-number', newNumber);
            });
        }

        function updateQuestionCounter(type) {
            const container = document.getElementById(`${type}Questions`);
            const count = type === 'pretest' ? pretestQuestionCount : posttestQuestionCount;
            
            let counter = container.parentElement.querySelector('.question-counter');
            if (!counter) {
                counter = document.createElement('div');
                counter.className = 'question-counter';
                container.parentElement.insertBefore(counter, container);
            }
            
            counter.innerHTML = `
                <i class="fas fa-list-ol"></i> 
                <span>${count} de ${MAX_QUESTIONS} preguntas agregadas</span>
            `;
        }

        function collectQuestions(type) {
            const container = document.getElementById(`${type}Questions`);
            const questionCards = container.querySelectorAll('.question-card');
            const questions = [];
            
            for (let i = 0; i < questionCards.length; i++) {
                const card = questionCards[i];
                const questionId = card.id;
                
                const questionText = document.getElementById(`${questionId}-text`).value.trim();
                if (!questionText) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Pregunta Vac√≠a',
                        text: `Complete la pregunta ${i + 1} del ${type === 'pretest' ? 'Pretest' : 'Post-test'}`,
                    });
                    return null;
                }
                
                const options = {
                    a: document.getElementById(`${questionId}-text-a`).value.trim(),
                    b: document.getElementById(`${questionId}-text-b`).value.trim(),
                    c: document.getElementById(`${questionId}-text-c`).value.trim(),
                    d: document.getElementById(`${questionId}-text-d`).value.trim()
                };
                
                if (!options.a || !options.b || !options.c || !options.d) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Opciones Incompletas',
                        text: `Complete todas las opciones de la pregunta ${i + 1}`,
                    });
                    return null;
                }
                
                const correctAnswer = document.querySelector(`input[name="${questionId}-correct"]:checked`);
                if (!correctAnswer) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Respuesta Correcta',
                        text: `Seleccione la respuesta correcta para la pregunta ${i + 1}`,
                    });
                    return null;
                }
                
                questions.push({
                    number: i + 1,
                    question: questionText,
                    options: options,
                    correctAnswer: correctAnswer.value
                });
            }
            
            return questions;
        }
// Lee SOLO el personal marcado en "Personal Capacitado"
function getSelectedStaff() {
  // Busca checkboxes marcados dentro del contenedor de personal
  const checks = document.querySelectorAll('#trainingStaffContainer input.trainingStaff:checked');
  // Devuelve un array de valores limpios
  return Array.from(checks)
    .map(cb => (cb.value || '').trim())
    .filter(Boolean);
}

        async function saveTraining() {
    const titleInput = document.getElementById('trainingTitle');
    const descInput = document.getElementById('trainingDescription');
    const dateInput = document.getElementById('trainingDate');
    const deptInput = document.getElementById('trainingDepartment');
    const durationInput = document.getElementById('trainingDuration');

    const title = titleInput ? titleInput.value.trim() : '';
    const description = descInput ? descInput.value.trim() : '';
    const trainingDate = dateInput ? dateInput.value : '';
    const department = deptInput ? deptInput.value : '';
    const duration = durationInput ? durationInput.value : '';

    // Solo el personal marcado (checkboxes)
    const selectedStaff = getSelectedStaff();

    if (!title || !description || !trainingDate || !department || !duration || selectedStaff.length === 0) {
        let missingMsg = 'Por favor completa todos los campos requeridos (*)';
        if (selectedStaff.length === 0) {
            missingMsg += ' y marca al menos una casilla en "Personal Capacitado".';
        }
        Swal.fire({ icon: 'warning', title: 'Campos Incompletos', text: missingMsg });
        if (titleInput) titleInput.scrollIntoView({ behavior: 'smooth' });
        return;
    }

    // NUEVO: Recopilar preguntas del pretest y postest
    const pretestQuestions = collectQuestions('pretest');
    const posttestQuestions = collectQuestions('posttest');
    
    // Validar que hay al menos algunas preguntas
    if (!pretestQuestions || pretestQuestions.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Sin Preguntas de Pretest',
            text: 'Debes agregar al menos una pregunta al pretest',
            confirmButtonText: 'Entendido'
        });
        document.getElementById('pretestQuestions').scrollIntoView({ behavior: 'smooth' });
        return;
    }

    if (!posttestQuestions || posttestQuestions.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Sin Preguntas de Postest',
            text: 'Debes agregar al menos una pregunta al post-test',
            confirmButtonText: 'Entendido'
        });
        document.getElementById('posttestQuestions').scrollIntoView({ behavior: 'smooth' });
        return;
    }

    const accessCode = generateAccessCode();
    const createdAtISO = new Date().toISOString();

    const trainingData = {
        title,
        description,
        trainingDate,
        department,
        duration,
        staffList: selectedStaff,
        accessCode,
        status: 'active',
        createdAtISO,
        pretestQuestions: pretestQuestions,
        posttestQuestions: posttestQuestions
    };

    // Mostrar indicador de carga
    Swal.fire({
        title: 'Guardando Capacitaci√≥n...',
        html: 'Por favor espera mientras se guarda la capacitaci√≥n y las preguntas',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    // PASO 1: Guardar la capacitaci√≥n
    const trainingResult = await sendTrainingToAirtable(trainingData);
    
    if (!trainingResult || !trainingResult.id) {
        Swal.fire({
            icon: 'error',
            title: 'Error al Guardar',
            text: 'No se pudo guardar la capacitaci√≥n en Airtable. Verifica la conexi√≥n y los campos.'
        });
        return;
    }

    console.log('‚úÖ Capacitaci√≥n guardada con ID:', trainingResult.id);

    // PASO 2: Guardar preguntas del pretest
    const pretestSaved = await saveQuestionsToAirtable(
        pretestQuestions, 
        trainingResult.id, 
        'pretest'
    );

    // PASO 3: Guardar preguntas del postest
    const posttestSaved = await saveQuestionsToAirtable(
        posttestQuestions, 
        trainingResult.id, 
        'posttest'
    );

    // Respaldo local
    const trainings = JSON.parse(localStorage.getItem('trainings') || '[]');
    trainings.push(trainingData);
    localStorage.setItem('trainings', JSON.stringify(trainings));

    // Limpiar formulario
    if (titleInput) titleInput.value = '';
    if (descInput) descInput.value = '';
    if (dateInput) dateInput.value = '';
    if (deptInput) deptInput.value = '';
    if (durationInput) durationInput.value = '';
    document.querySelectorAll('input.trainingStaff:checked, .trainingStaff:checked, input[name="personalCapacitado[]"]:checked')
        .forEach(cb => cb.checked = false);
    
    // Limpiar preguntas
    document.getElementById('pretestQuestions').innerHTML = '';
    document.getElementById('posttestQuestions').innerHTML = '';
    pretestQuestionCount = 0;
    posttestQuestionCount = 0;
    document.querySelectorAll('.question-counter').forEach(c => c.remove());

    // Mensaje final
    Swal.fire({
        icon: 'success',
        title: '¬°Capacitaci√≥n Guardada!',
        html: `
            <div style="margin: 20px 0;">
                <p>C√≥digo de Acceso:</p>
                <h2 style="color: #667eea; margin: 10px 0;">${accessCode}</h2>
                <p style="font-size: 0.9em; color: #666;">Comparte este c√≥digo con los participantes</p>
                <hr style="margin: 15px 0;">
                <p style="font-size: 0.85em;">
                    ‚úÖ Capacitaci√≥n guardada en Airtable<br>
                    ${pretestSaved ? '‚úÖ' : '‚ö†Ô∏è'} ${pretestQuestions.length} preguntas de pretest ${pretestSaved ? 'guardadas' : 'con error'}<br>
                    ${posttestSaved ? '‚úÖ' : '‚ö†Ô∏è'} ${posttestQuestions.length} preguntas de postest ${posttestSaved ? 'guardadas' : 'con error'}
                </p>
            </div>
        `,
        confirmButtonText: 'Generar QR',
        showCancelButton: true,
        cancelButtonText: 'Cerrar'
    }).then((result) => {
        if (result.isConfirmed) {
            showQRCode(accessCode, title);
        }
    });

    if (typeof renderTrainingsList === 'function') {
        renderTrainingsList();
    }
}

// Env√≠a la capacitaci√≥n a Airtable a trav√©s del proxy Netlify
async function sendTrainingToAirtable(trainingData) {
    try {
        console.log('üì§ Enviando capacitaci√≥n a Airtable...');
        console.log('Datos originales:', trainingData);

        // Usar solo los campos que existen en Airtable
        const airtableRecord = {
            fields: {
                "T√≠tulo": trainingData.title,
                "Descripci√≥n": trainingData.description,
                "Fecha": trainingData.trainingDate,
                "Departamento": trainingData.department,
                "Duraci√≥n": trainingData.duration,
                "C√≥digo de Acceso": trainingData.accessCode,
                "Estado": trainingData.status
                // Campos "Personal" y "Creado En" omitidos (no existen o causan errores)
            }
        };

        console.log('üìã Record a enviar:', JSON.stringify(airtableRecord, null, 2));

        const response = await fetch('/.netlify/functions/airtable-proxy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                method: 'POST',
                path: '/Capacitaciones',
                body: airtableRecord
            })
        });

        const responseText = await response.text();
        console.log(`üì• Respuesta HTTP ${response.status}:`, responseText);

        if (!response.ok) {
            console.error('‚ùå Error HTTP:', response.status);
            console.error('Detalle:', responseText);
            return false;
        }

        const data = JSON.parse(responseText);
        console.log('‚úÖ Respuesta exitosa:', data);

        // IMPORTANTE: Retornar el ID del registro creado
        if (data && data.id) {
            console.log('‚úÖ Capacitaci√≥n guardada con ID:', data.id);
            return { success: true, id: data.id };
        }

        return false;
    } catch (err) {
        console.error('‚ùå Error enviando a Airtable:', err.message);
        console.error('Stack:', err.stack);
        return false;
    }
}

// NUEVA FUNCI√ìN: Guarda las preguntas en Airtable
async function saveQuestionsToAirtable(questions, trainingRecordId, type) {
    try {
        console.log(`üìù Guardando ${questions.length} preguntas de ${type}...`);
        
        if (!questions || questions.length === 0) {
            console.log(`‚ö†Ô∏è No hay preguntas de ${type} para guardar`);
            return true;
        }

        // Convertir las preguntas al formato de Airtable
        const records = questions.map(q => ({
            fields: {
                "Capacitaci√≥n": [trainingRecordId],  // Link al registro de la capacitaci√≥n
                "Tipo": type === 'pretest' ? 'Pretest' : 'Postest',
                "N√∫mero": q.number,
                "Pregunta": q.question,
                "Opci√≥n A": q.options.a,
                "Opci√≥n B": q.options.b,
                "Opci√≥n C": q.options.c,
                "Opci√≥n D": q.options.d,
                "Respuesta Correcta": q.correctAnswer
            }
        }));

        console.log(`üìã Preguntas a guardar:`, records);

        // Guardar todas las preguntas en un solo request
        const response = await fetch('/.netlify/functions/airtable-proxy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                method: 'POST',
                path: '/Preguntas',
                body: { records: records }  // Airtable acepta m√∫ltiples records
            })
        });

        const responseText = await response.text();
        console.log(`üì• Respuesta guardado de preguntas HTTP ${response.status}:`, responseText);

        if (!response.ok) {
            console.error(`‚ùå Error guardando preguntas de ${type}:`, response.status);
            console.error('Detalle:', responseText);
            return false;
        }

        const data = JSON.parse(responseText);
        console.log(`‚úÖ ${questions.length} preguntas de ${type} guardadas exitosamente`);
        
        return true;

    } catch (err) {
        console.error(`‚ùå Error guardando preguntas de ${type}:`, err);
        return false;
    }
}


        function generateAccessCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function showQRCode(accessCode, title) {
            const modal = document.getElementById('qrModal');
            const qrContainer = document.getElementById('qrcode');
            
            qrContainer.innerHTML = '';
            
            const accessUrl = `${window.location.origin}?code=${accessCode}`;
            new QRCode(qrContainer, {
                text: accessUrl,
                width: 256,
                height: 256,
                colorDark: '#667eea',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
            
            document.getElementById('modalAccessCode').textContent = accessCode;
            document.getElementById('modalAccessLink').textContent = accessUrl;
            
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        function copyLink() {
            const link = document.getElementById('modalAccessLink').textContent;
            const code = document.getElementById('modalAccessCode').textContent;
            
            const text = `üè• Acceso a Capacitaci√≥n\n\nC√≥digo: ${code}\nLink: ${link}\n\nHospital Susana L√≥pez de Valencia`;
            
            navigator.clipboard.writeText(text).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'Copiado',
                    text: 'Link copiado al portapapeles',
                    timer: 2000,
                    showConfirmButton: false
                });
            });
        }

        function shareWhatsApp() {
            const code = document.getElementById('modalAccessCode').textContent;
            const link = document.getElementById('modalAccessLink').textContent;
            
            const message = `üè• *Acceso a Capacitaci√≥n*\nHospital Susana L√≥pez de Valencia\n\n*C√≥digo:* ${code}\n*Link:* ${link}`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function downloadQR() {
            const canvas = document.querySelector('#qrcode canvas');
            if (canvas) {
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const code = document.getElementById('modalAccessCode').textContent;
                    link.download = `QR-${code}.png`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Descargado',
                        timer: 2000,
                        showConfirmButton: false
                    });
                });
            }
        }

        function resetForm() {
            if (pretestQuestionCount > 0 || posttestQuestionCount > 0) {
                Swal.fire({
                    title: '¬øLimpiar Formulario?',
                    text: 'Se perder√°n todas las preguntas',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'S√≠, limpiar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        performReset();
                    }
                });
            } else {
                performReset();
            }
        }

        function performReset() {
            document.getElementById('trainingForm').reset();
            document.getElementById('pretestQuestions').innerHTML = '';
            document.getElementById('posttestQuestions').innerHTML = '';
            pretestQuestionCount = 0;
            posttestQuestionCount = 0;
            document.querySelectorAll('.question-counter').forEach(c => c.remove());
            
            Swal.fire({
                icon: 'success',
                title: 'Formulario Limpiado',
                timer: 1500,
                showConfirmButton: false
            });
        }

        // ==================== CONEXI√ìN AIRTABLE SEGURA ====================
        
        // Variables globales para conexi√≥n
        let airtableConnected = false;
        let connectionCheckInterval = null;
        
        // Funci√≥n para actualizar el indicador de conexi√≥n
        function updateConnectionIndicator(status) {
            const indicator = document.getElementById('connectionIndicator');
            const text = document.getElementById('connectionText');
            
            if (!indicator) return;
            
            indicator.classList.remove('connected', 'disconnected', 'checking');
            
            switch(status) {
                case 'connected':
                    indicator.classList.add('connected');
                    text.textContent = '‚úì Airtable Conectado';
                    airtableConnected = true;
                    break;
                case 'disconnected':
                    indicator.classList.add('disconnected');
                    text.textContent = '‚úó Airtable Desconectado';
                    airtableConnected = false;
                    break;
                case 'checking':
                    indicator.classList.add('checking');
                    text.textContent = '‚ü≥ Verificando...';
                    break;
            }
        }
        
        // Funci√≥n para verificar conexi√≥n con Airtable (SEGURA - via Netlify)
        async function testAirtableConnection() {
    try {
        updateConnectionIndicator('checking');

        const response = await fetch('/.netlify/functions/airtable-proxy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                method: 'GET',
                path: '/Capacitaciones?maxRecords=1',
                body: null
            })
        });

        if (!response.ok) {
            updateConnectionIndicator('disconnected');
            console.error('‚ùå Error HTTP al verificar conexi√≥n:', response.status);
            return false;
        }

        const data = await response.json();
        console.log('üîé Respuesta airtable-proxy:', data);

        if (data && data.success === true && Array.isArray(data.records)) {
            updateConnectionIndicator('connected');
            return true;
        } else {
            updateConnectionIndicator('disconnected');
            console.error('‚ùå Proxy respondi√≥ pero sin datos v√°lidos');
            return false;
        }
    } catch (error) {
        updateConnectionIndicator('disconnected');
        console.error('‚ùå Error al verificar conexi√≥n:', error.message);
        return false;
    }
}
        
        // Verificar conexi√≥n al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîÑ Iniciando verificaci√≥n de conexi√≥n...');
            testAirtableConnection();
            
            // Verificar conexi√≥n cada 30 segundos
            if (connectionCheckInterval) clearInterval(connectionCheckInterval);
            connectionCheckInterval = setInterval(() => {
                testAirtableConnection();
            }, 30000);
        });
        
        // Limpiar intervalo al descargar
        window.addEventListener('beforeunload', () => {
            if (connectionCheckInterval) clearInterval(connectionCheckInterval);
        });
        
        // ==================== FIN CONEXI√ìN AIRTABLE ====================


        // ==================== GESTIONAR CAPACITACIONES ====================
        
        // Variable global para almacenar las capacitaciones
        let allTrainings = [];
        
        // Cargar capacitaciones desde Airtable
        async function loadTrainings() {
            try {
                console.log('üìã Cargando capacitaciones desde Airtable...');
                
                // Mostrar loading
                document.getElementById('trainingsLoading').style.display = 'block';
                document.getElementById('trainingsEmpty').style.display = 'none';
                document.getElementById('trainingsGrid').innerHTML = '';
                
                const response = await fetch('/.netlify/functions/airtable-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'GET',
                        path: '/Capacitaciones?sort[0][field]=Creado%20En&sort[0][direction]=desc',
                        body: null
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Respuesta de Airtable:', data);
                
                // Ocultar loading
                document.getElementById('trainingsLoading').style.display = 'none';
                
                if (data.success && data.records && data.records.length > 0) {
                    allTrainings = data.records;
                    renderTrainingsList();
                    updateDashboardStats();
                } else {
                    document.getElementById('trainingsEmpty').style.display = 'block';
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando capacitaciones:', error);
                document.getElementById('trainingsLoading').style.display = 'none';
                document.getElementById('trainingsEmpty').style.display = 'block';
                
                Swal.fire({
                    icon: 'error',
                    title: 'Error al Cargar',
                    text: 'No se pudieron cargar las capacitaciones. Verifica tu conexi√≥n.',
                    confirmButtonText: 'Reintentar'
                }).then(() => loadTrainings());
            }
        }
        
        // Renderizar lista de capacitaciones
        function renderTrainingsList() {
            const grid = document.getElementById('trainingsGrid');
            grid.innerHTML = '';
            
            if (allTrainings.length === 0) {
                document.getElementById('trainingsEmpty').style.display = 'block';
                return;
            }
            
            allTrainings.forEach(training => {
                const fields = training.fields;
                const card = createTrainingCard(training.id, fields);
                grid.innerHTML += card;
            });
        }
        
        // Crear tarjeta de capacitaci√≥n
        function createTrainingCard(id, fields) {
            const title = fields['T√≠tulo'] || 'Sin t√≠tulo';
            const description = fields['Descripci√≥n'] || 'Sin descripci√≥n';
            const date = fields['Fecha'] || '';
            const department = fields['Departamento'] || '';
            const duration = fields['Duraci√≥n'] || '';
            const accessCode = fields['C√≥digo de Acceso'] || '';
            const status = fields['Estado'] || 'active';
            
            const formattedDate = date ? new Date(date).toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            }) : 'Sin fecha';
            
            return `
                <div class="training-card">
                    <div class="training-card-header">
                        <div>
                            <h3 class="training-title">${title}</h3>
                            <span class="training-status ${status}">${status === 'active' ? 'Activa' : 'Inactiva'}</span>
                        </div>
                    </div>
                    
                    <div class="training-info">
                        <div class="training-info-item">
                            <i class="fas fa-calendar"></i>
                            <span>${formattedDate}</span>
                        </div>
                        <div class="training-info-item">
                            <i class="fas fa-building"></i>
                            <span>${department}</span>
                        </div>
                        <div class="training-info-item">
                            <i class="fas fa-clock"></i>
                            <span>${duration}</span>
                        </div>
                    </div>
                    
                    <div class="training-code">
                        <div class="training-code-label">C√≥digo de Acceso</div>
                        <div class="training-code-value">${accessCode}</div>
                    </div>
                    
                    <div class="training-actions">
                        <button class="btn-action btn-view" onclick="viewTrainingDetails('${id}')">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                        <button class="btn-action btn-qr" onclick="showTrainingQR('${accessCode}', '${title}')">
                            <i class="fas fa-qrcode"></i> QR
                        </button>
                        <button class="btn-action btn-delete" onclick="deleteTraining('${id}', '${title}')">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Ver detalles de capacitaci√≥n
        async function viewTrainingDetails(trainingId) {
            try {
                console.log('üëÅÔ∏è Cargando detalles de capacitaci√≥n:', trainingId);
                
                // Buscar la capacitaci√≥n en el array
                const training = allTrainings.find(t => t.id === trainingId);
                if (!training) {
                    throw new Error('Capacitaci√≥n no encontrada');
                }
                
                const fields = training.fields;
                
                // Cargar preguntas de la capacitaci√≥n
                const questionsResponse = await fetch('/.netlify/functions/airtable-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'GET',
                        path: `/Preguntas?filterByFormula=SEARCH("${trainingId}",{Capacitacion (from Capacitaci√≥n)})`,
                        body: null
                    })
                });
                
                const questionsData = await questionsResponse.json();
                const questions = questionsData.success ? questionsData.records : [];
                
                // Renderizar detalles
                const detailsBody = document.getElementById('detailsBody');
                detailsBody.innerHTML = `
                    <div class="details-section">
                        <h3><i class="fas fa-info-circle"></i> Informaci√≥n General</h3>
                        <div class="training-info">
                            <div class="training-info-item">
                                <i class="fas fa-heading"></i>
                                <strong>T√≠tulo:</strong> ${fields['T√≠tulo'] || 'N/A'}
                            </div>
                            <div class="training-info-item">
                                <i class="fas fa-align-left"></i>
                                <strong>Descripci√≥n:</strong> ${fields['Descripci√≥n'] || 'N/A'}
                            </div>
                            <div class="training-info-item">
                                <i class="fas fa-calendar"></i>
                                <strong>Fecha:</strong> ${fields['Fecha'] ? new Date(fields['Fecha']).toLocaleDateString('es-ES') : 'N/A'}
                            </div>
                            <div class="training-info-item">
                                <i class="fas fa-building"></i>
                                <strong>Departamento:</strong> ${fields['Departamento'] || 'N/A'}
                            </div>
                            <div class="training-info-item">
                                <i class="fas fa-clock"></i>
                                <strong>Duraci√≥n:</strong> ${fields['Duraci√≥n'] || 'N/A'}
                            </div>
                            <div class="training-info-item">
                                <i class="fas fa-key"></i>
                                <strong>C√≥digo de Acceso:</strong> ${fields['C√≥digo de Acceso'] || 'N/A'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="details-section">
                        <h3><i class="fas fa-question-circle"></i> Preguntas (${questions.length} total)</h3>
                        ${questions.length > 0 ? `
                            <div class="questions-list">
                                ${questions.map((q, index) => {
                                    const qFields = q.fields;
                                    const correctAnswer = qFields['Respuesta Corecta'] || '';
                                    return `
                                        <div class="question-item">
                                            <div class="question-number">Pregunta ${index + 1}</div>
                                            <div class="question-text">${qFields['name'] || 'Sin pregunta'}</div>
                                            <div class="question-options">
                                                <div class="question-option ${correctAnswer === 'B' ? 'correct' : ''}">
                                                    <strong>B)</strong> ${qFields['Opci√≥n B'] || 'N/A'}
                                                    ${correctAnswer === 'B' ? '<i class="fas fa-check-circle" style="color: #4caf50; margin-left: auto;"></i>' : ''}
                                                </div>
                                                <div class="question-option ${correctAnswer === 'C' ? 'correct' : ''}">
                                                    <strong>C)</strong> ${qFields['Opci√≥n C'] || 'N/A'}
                                                    ${correctAnswer === 'C' ? '<i class="fas fa-check-circle" style="color: #4caf50; margin-left: auto;"></i>' : ''}
                                                </div>
                                                <div class="question-option ${correctAnswer === 'D' ? 'correct' : ''}">
                                                    <strong>D)</strong> ${qFields['Opci√≥n D'] || 'N/A'}
                                                    ${correctAnswer === 'D' ? '<i class="fas fa-check-circle" style="color: #4caf50; margin-left: auto;"></i>' : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : '<p style="text-align: center; color: #999;">No hay preguntas registradas</p>'}
                    </div>
                `;
                
                // Mostrar modal
                document.getElementById('detailsModal').classList.add('active');
                
            } catch (error) {
                console.error('‚ùå Error cargando detalles:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudieron cargar los detalles de la capacitaci√≥n'
                });
            }
        }
        
        // Cerrar modal de detalles
        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.remove('active');
        }
        
        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const detailsModal = document.getElementById('detailsModal');
            if (event.target === detailsModal) {
                closeDetailsModal();
            }
            const qrModal = document.getElementById('qrModal');
            if (event.target === qrModal) {
                closeModal();
            }
        };
        
        // Mostrar QR de capacitaci√≥n espec√≠fica
        function showTrainingQR(accessCode, title) {
            showQRCode(accessCode, title);
        }
        
        // Eliminar capacitaci√≥n
        async function deleteTraining(trainingId, title) {
            const result = await Swal.fire({
                title: '¬øEliminar Capacitaci√≥n?',
                html: `Se eliminar√° la capacitaci√≥n:<br><strong>${title}</strong><br><br>Esta acci√≥n no se puede deshacer.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            });
            
            if (!result.isConfirmed) return;
            
            try {
                Swal.fire({
                    title: 'Eliminando...',
                    text: 'Por favor espera',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });
                
                // Eliminar de Airtable
                const response = await fetch('/.netlify/functions/airtable-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'DELETE',
                        path: `/Capacitaciones/${trainingId}`,
                        body: null
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Error al eliminar');
                }
                
                Swal.fire({
                    icon: 'success',
                    title: '¬°Eliminada!',
                    text: 'La capacitaci√≥n ha sido eliminada',
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Recargar lista
                loadTrainings();
                
            } catch (error) {
                console.error('‚ùå Error eliminando:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo eliminar la capacitaci√≥n'
                });
            }
        }
        
        // Actualizar estad√≠sticas del dashboard
        function updateDashboardStats() {
            document.getElementById('totalTrainings').textContent = allTrainings.length;
        }
        
        // Cargar capacitaciones cuando se cambia a la pesta√±a "Gestionar"
        const originalSwitchTab = switchTab;
        window.switchTab = function(tabName) {
            originalSwitchTab(tabName);
            if (tabName === 'manage') {
                loadTrainings();
            }
        };

        // ==================== CHARTS ====================
        
        let participationsChart = null;
        let departmentChart = null;

        function initializeCharts() {
            if (participationsChart) participationsChart.destroy();
            if (departmentChart) departmentChart.destroy();
            
            const ctx1 = document.getElementById('participationsChart');
            if (ctx1) {
                participationsChart = new Chart(ctx1.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
                        datasets: [{
                            label: 'Participaciones',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            const ctx2 = document.getElementById('departmentChart');
            if (ctx2) {
                departmentChart = new Chart(ctx2.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['Enfermer√≠a', 'Medicina', 'Admin', 'Lab', 'Radiolog√≠a'],
                        datasets: [{
                            label: 'Rendimiento',
                            data: [0, 0, 0, 0, 0],
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.8)',
                                'rgba(100, 210, 80, 0.8)',
                                'rgba(217, 65, 244, 0.8)',
                                'rgba(248, 150, 30, 0.8)',
                                'rgba(52, 172, 224, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }
        }
        
        // ==================== FUNCIONES PARA GENERAR QR ====================
        
        /**
         * Genera un c√≥digo √∫nico de 6 caracteres alfanum√©ricos
         */
        function generateAccessCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        /**
         * Muestra el modal con el QR generado
         */
        async function showTrainingQR(accessCode, trainingTitle) {
            try {
                console.log(`üì± Generando QR para: ${trainingTitle} (${accessCode})`);
                
                // Generar c√≥digo √∫nico si es necesario
                const finalCode = accessCode && accessCode.trim() ? accessCode : generateAccessCode();
                
                // Construir URL con par√°metros
                const baseUrl = window.location.origin + window.location.pathname;
                const qrUrl = `${baseUrl}?code=${finalCode}&auto=true`;
                
                console.log(`üîó URL QR: ${qrUrl}`);
                
                // Limpiar contenedor anterior
                const qrContainer = document.getElementById('qrCode');
                qrContainer.innerHTML = '';
                
                // Generar QR usando QRCode.js
                new QRCode(qrContainer, {
                    text: qrUrl,
                    width: 300,
                    height: 300,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                // Llenar la URL en el campo de texto
                document.getElementById('qrUrl').value = qrUrl;
                
                // Guardar datos para descargar despu√©s
                window.currentQRData = {
                    url: qrUrl,
                    code: finalCode,
                    title: trainingTitle
                };
                
                // Mostrar modal
                document.getElementById('qrModal').style.display = 'flex';
                
                Swal.fire({
                    icon: 'success',
                    title: '¬°QR Generado!',
                    text: `C√≥digo: ${finalCode}\n\nCompartir este enlace o escanear el QR`,
                    timer: 2000,
                    showConfirmButton: false
                });
                
            } catch (error) {
                console.error('‚ùå Error generando QR:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo generar el c√≥digo QR: ' + error.message
                });
            }
        }
        
        /**
         * Cierra el modal del QR
         */
        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }
        
        /**
         * Copia la URL del QR al portapapeles
         */
        function copyQRUrl() {
            const qrUrlInput = document.getElementById('qrUrl');
            qrUrlInput.select();
            document.execCommand('copy');
            
            Swal.fire({
                icon: 'success',
                title: '¬°Copiado!',
                text: 'El enlace ha sido copiado al portapapeles',
                timer: 1500,
                showConfirmButton: false
            });
        }
        
        /**
         * Descarga la imagen del QR
         */
        function downloadQRCode() {
            try {
                const qrContainer = document.getElementById('qrCode');
                const qrImage = qrContainer.querySelector('img');
                
                if (!qrImage) {
                    throw new Error('No se encontr√≥ la imagen del QR');
                }
                
                // Crear elemento de descarga
                const link = document.createElement('a');
                link.href = qrImage.src;
                link.download = `QR-${window.currentQRData.code}-${window.currentQRData.title.replace(/\s+/g, '-')}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                Swal.fire({
                    icon: 'success',
                    title: 'Descargado',
                    text: 'El c√≥digo QR ha sido descargado',
                    timer: 1500,
                    showConfirmButton: false
                });
                
            } catch (error) {
                console.error('‚ùå Error descargando QR:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo descargar el QR'
                });
            }
        }
        
        /**
         * Abre el enlace del QR en una nueva pesta√±a (para pruebas)
         */
        function testQRCode() {
            if (window.currentQRData) {
                window.open(window.currentQRData.url, '_blank');
            }
        }
    </script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL DE LINK POSTTEST - PRETEST ‚Üí POSTTEST
     Modal que muestra QR y link permanente para posttest
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<div id="postestLinkModal" class="modal-overlay" style="display: none;">
  <div class="modal-content posttest-modal" style="max-width: 600px;">
    <button class="close-btn" onclick="closePostestLinkModal()">‚úï</button>
    
    <div class="posttest-modal-header">
      <i class="fas fa-check-circle" style="font-size: 3rem; color: #28a745; margin-bottom: 1rem;"></i>
      <h2>¬°Pretest Completado!</h2>
      <p style="color: #666; margin-top: 0.5rem;">
        Tu respuesta ha sido guardada correctamente
      </p>
    </div>

    <div class="posttest-modal-body">
      <!-- Secci√≥n del QR -->
      <div class="posttest-qr-section">
        <h3 style="color: #667eea; margin-bottom: 1rem; text-align: center;">
          <i class="fas fa-qrcode"></i> C√≥digo para Posttest
        </h3>
        
        <div id="postestQrCode" style="
          display: flex;
          justify-content: center;
          padding: 1.5rem;
          background: #f8f9ff;
          border-radius: 12px;
          margin-bottom: 1.5rem;
        "></div>

        <div style="text-align: center; margin-bottom: 2rem;">
          <button onclick="downloadPostestQR()" class="btn btn-secondary" style="
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
          " onmouseover="this.style.background='#e8e8e8'" onmouseout="this.style.background='#f0f0f0'">
            <i class="fas fa-download"></i> Descargar QR
          </button>
        </div>
      </div>

      <!-- Secci√≥n del Link -->
      <div class="posttest-link-section">
        <h3 style="color: #667eea; margin-bottom: 1rem;">
          <i class="fas fa-link"></i> Link Permanente
        </h3>

        <div style="
          background: #f5f5f5;
          padding: 1rem;
          border-radius: 8px;
          border: 1px solid #e0e0e0;
          margin-bottom: 1rem;
        ">
          <input 
            type="text" 
            id="postestUrlInput" 
            readonly 
            style="
              width: 100%;
              padding: 0.75rem;
              border: none;
              background: white;
              border-radius: 4px;
              font-family: 'Courier New', monospace;
              font-size: 12px;
              word-break: break-all;
            "
          >
        </div>

        <button onclick="copyPostestUrl()" class="btn btn-primary" style="
          width: 100%;
          padding: 0.75rem 1.5rem;
          background: #667eea;
          color: white;
          border: none;
          border-radius: 8px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 0.5rem;
          margin-bottom: 1rem;
        " onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#667eea'">
          <i class="fas fa-copy"></i> Copiar Link
        </button>
      </div>

      <!-- Instrucciones -->
      <div style="
        background: #e8f5e9;
        border-left: 4px solid #4caf50;
        padding: 1rem;
        border-radius: 4px;
        margin-top: 1.5rem;
      ">
        <p style="color: #2e7d32; margin: 0; font-weight: 500;">
          <i class="fas fa-info-circle"></i> Informaci√≥n Importante
        </p>
        <ul style="color: #558b2f; font-size: 0.9rem; margin: 0.5rem 0 0 1.5rem; padding: 0;">
          <li>Este link es √∫nico para ti y permanecer√° v√°lido durante toda la capacitaci√≥n</li>
          <li>Guarda el link o escanea el QR para usarlo despu√©s de la capacitaci√≥n</li>
          <li>Podr√°s responder el posttest desde cualquier dispositivo usando este c√≥digo</li>
          <li>Solo necesitar√°s este c√≥digo para acceder al posttest</li>
        </ul>
      </div>

      <!-- C√≥digo corto -->
      <div style="
        background: #fff3e0;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        margin-top: 1.5rem;
      ">
        <p style="color: #666; font-size: 0.9rem; margin: 0 0 0.5rem 0;">
          O usa este c√≥digo:
        </p>
        <div style="
          font-size: 1.3rem;
          font-weight: bold;
          color: #e65100;
          font-family: 'Courier New', monospace;
          letter-spacing: 2px;
        " id="postestCodeDisplay">
          ---
        </div>
      </div>
    </div>

    <div class="posttest-modal-footer" style="
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e0e0e0;
    ">
      <button onclick="closePostestLinkModal()" class="btn-secondary" style="
        flex: 1;
        padding: 0.75rem 1.5rem;
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
      " onmouseover="this.style.background='#e8e8e8'" onmouseout="this.style.background='#f0f0f0'">
        Cerrar
      </button>
      <button onclick="copyPostestUrl()" class="btn-primary" style="
        flex: 1;
        padding: 0.75rem 1.5rem;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
      " onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#667eea'">
        Copiar Link
      </button>
    </div>
  </div>
</div>

<!-- CSS para el Modal Posttest -->
<style>
  .posttest-modal {
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    padding: 2rem;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
  }

  .posttest-modal-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .posttest-modal-header h2 {
    color: #333;
    font-size: 1.8rem;
    margin: 1rem 0 0.5rem 0;
  }

  .posttest-qr-section {
    text-align: center;
    margin-bottom: 2rem;
  }

  .posttest-link-section {
    margin: 2rem 0;
  }

  .posttest-link-section h3 {
    margin-bottom: 1rem;
  }

  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 1rem;
  }

  .modal-overlay.show {
    display: flex;
  }

  .close-btn {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #999;
    transition: color 0.3s;
  }

  .close-btn:hover {
    color: #333;
  }

  /* Responsive */
  @media (max-width: 600px) {
    .posttest-modal {
      padding: 1.5rem;
      margin: 0 1rem;
    }

    .posttest-modal-header h2 {
      font-size: 1.5rem;
    }

    #postestQrCode {
      width: 200px !important;
      height: 200px !important;
      margin: 0 auto 1rem !important;
    }

    .posttest-modal-footer {
      flex-direction: column;
    }

    .posttest-modal-footer button {
      width: 100% !important;
    }
  }
</style>

</body>
</html>
